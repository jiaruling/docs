import{r as e,o,a as c,b as n,d as t,F as l,c as a,e as s}from"./app.9a368eb2.js";import{_ as u}from"./plugin-vue_export-helper.21dcd24c.js";var r="/docs/images/daili.png",i="/docs/images/zhuanfa.png",k="/docs/images/proxy_server.png",b="/docs/images/mproxy.png",m="/docs/images/statusCode101.png",d="/docs/images/x-forward-for.png",g="/docs/images/x-real-ip.png",f="/docs/images/ronduan.png",h="/docs/images/http-https.jpg",q="/docs/images/duolufuyong.jpg",y="/docs/images/putongrequest.jpg",w="/docs/images/msgpush.jpg";const v={},x=a('<h2 id="\u4EC0\u4E48\u662F\u7F51\u7EDC\u4EE3\u7406" tabindex="-1"><a class="header-anchor" href="#\u4EC0\u4E48\u662F\u7F51\u7EDC\u4EE3\u7406" aria-hidden="true">#</a> \u4EC0\u4E48\u662F\u7F51\u7EDC\u4EE3\u7406</h2><ul><li>\u7528\u6237\u901A\u8FC7\u4EE3\u7406\u8BF7\u6C42\u4FE1\u606F</li><li>\u8BF7\u6C42\u901A\u8FC7\u7F51\u7EDC\u4EE3\u7406\u5B8C\u6210\u8F6C\u53D1\u5230\u8FBE\u76EE\u6807\u670D\u52A1\u5668</li><li>\u76EE\u6807\u670D\u52A1\u5668\u54CD\u5E94\u540E\u518D\u901A\u8FC7\u7F51\u7EDC\u4EE3\u7406\u56DE\u4F20\u7ED9\u7528\u6237</li></ul><h3 id="\u7F51\u7EDC\u4EE3\u7406\u4E0E\u7F51\u7EDC\u8F6C\u53D1\u7684\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#\u7F51\u7EDC\u4EE3\u7406\u4E0E\u7F51\u7EDC\u8F6C\u53D1\u7684\u533A\u522B" aria-hidden="true">#</a> \u7F51\u7EDC\u4EE3\u7406\u4E0E\u7F51\u7EDC\u8F6C\u53D1\u7684\u533A\u522B</h3><ul><li><strong>\u7F51\u7EDC\u4EE3\u7406:</strong> \u7528\u6237\u4E0D\u76F4\u63A5\u8FDE\u63A5\u670D\u52A1\u5668\uFF0C\u7F51\u7EDC\u4EE3\u7406\u53BB\u8FDE\u63A5\uFF0C\u83B7\u53D6\u6570\u636E\u540E\u8FD4\u56DE\u7ED9\u7528\u6237\u3002</li></ul><p><img src="'+r+'" alt=""></p><ul><li><strong>\u7F51\u7EDC\u8F6C\u53D1</strong>: \u662F\u8DEF\u7531\u5668\u5BF9\u62A5\u6587\u7684\u8F6C\u53D1\u64CD\u4F5C\uFF0C\u4E2D\u95F4\u53EF\u80FD\u5BF9\u6570\u636E\u5305\u4FEE\u6539\u3002</li></ul><p><img src="'+i+`" alt=""></p><h3 id="\u7F51\u7EDC\u4EE3\u7406\u7C7B\u578B" tabindex="-1"><a class="header-anchor" href="#\u7F51\u7EDC\u4EE3\u7406\u7C7B\u578B" aria-hidden="true">#</a> \u7F51\u7EDC\u4EE3\u7406\u7C7B\u578B</h3><ul><li><strong>\u6B63\u5411\u4EE3\u7406\uFF1A<strong>\u662F\u4E00\u79CD</strong>\u5BA2\u6237\u7AEF\u7684\u4EE3\u7406</strong>\u6280\u672F\uFF0C\u5E2E\u52A9\u5BA2\u6237\u7AEF\u8BBF\u95EE\u65E0\u6CD5\u8BBF\u95EE\u7684\u670D\u52A1\u8D44\u6E90\uFF0C\u53EF\u4EE5\u9690\u85CF\u7528\u6237\u771F\u5B9EIP\u3002\u6BD4\u5982\uFF1A\u6D4F\u89C8\u5668web\u4EE3\u7406\uFF0CVPN\u7B49\u3002 <ul><li>\u4EE3\u7406\u63A5\u6536\u5BA2\u6237\u7AEF\u8BF7\u6C42\uFF0C\u590D\u5236\u539F\u8BF7\u6C42\u5BF9\u8C61\uFF0C\u5E76\u6839\u636E\u6570\u636E\u914D\u7F6E\u65B0\u8BF7\u6C42\u7684\u5404\u79CD\u53C2\u6570</li><li>\u628A\u65B0\u8BF7\u6C42\u53D1\u9001\u5230\u771F\u5B9E\u670D\u52A1\u7AEF\uFF0C\u5E76\u63A5\u6536\u670D\u52A1\u5668\u7AEF\u8FD4\u56DE</li><li>\u4EE3\u7406\u670D\u52A1\u5668\u5BF9\u76F8\u5E94\u505A\u4E00\u4E9B\u5904\u7406\uFF0C\u7136\u540E\u8FD4\u56DE\u7ED9\u5BA2\u6237\u7AEF</li></ul></li></ul><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// \u76EE\u524D\u5728Windows11 \u4E0A\u6CA1\u6709\u6D4B\u8BD5\u6210\u529F</span>
<span class="token comment">// \u9700\u8981\u5173\u95ED\u9632\u706B\u5899</span>
<span class="token comment">// \u53EA\u80FD\u8BBF\u95EEhttp\u7684\u670D\u52A1\uFF0C\u4E0D\u80FD\u8BBF\u95EEhttps\u7684\u670D\u52A1</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Pxy <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pxy<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received request %s %s %s\\n&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
	transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultTransport
	<span class="token comment">// step 1\uFF0C\u6D45\u62F7\u8D1D\u5BF9\u8C61\uFF0C\u7136\u540E\u5C31\u518D\u65B0\u589E\u5C5E\u6027\u6570\u636E</span>
	outReq <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
	<span class="token operator">*</span>outReq <span class="token operator">=</span> <span class="token operator">*</span>req
	<span class="token keyword">if</span> clientIP<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> prior<span class="token punctuation">,</span> ok <span class="token operator">:=</span> outReq<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			clientIP <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>prior<span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> clientIP
		<span class="token punctuation">}</span>
		outReq<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// step 2, \u8BF7\u6C42\u4E0B\u6E38</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> transport<span class="token punctuation">.</span><span class="token function">RoundTrip</span><span class="token punctuation">(</span>outReq<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		rw<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadGateway<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// step 3, \u628A\u4E0B\u6E38\u8BF7\u6C42\u5185\u5BB9\u8FD4\u56DE\u7ED9\u4E0A\u6E38</span>
	<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> res<span class="token punctuation">.</span>Header <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> value <span class="token punctuation">{</span>
			rw<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	rw<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Serve on :8080&quot;</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Pxy<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0:8080&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div></details><ul><li><strong>\u53CD\u5411\u4EE3\u7406\uFF1A<strong>\u662F\u4E00\u79CD</strong>\u670D\u52A1\u7AEF\u7684\u4EE3\u7406</strong>\u6280\u672F\uFF0C\u5E2E\u52A9\u670D\u52A1\u5668\u505A\u8D1F\u8F7D\u5747\u8861\u3001\u7F13\u5B58\u3001\u63D0\u4F9B\u5B89\u5168\u6821\u9A8C\u7B49\uFF0C\u53EF\u4EE5\u9690\u85CF\u670D\u52A1\u5668\u771F\u5B9EIP\u3002\u6BD4\u5982\uFF1ALVS\u6280\u672F\u3001nginx\u3001proxy_pass\u7B49 <ul><li>\u4EE3\u7406\u63A5\u6536\u5BA2\u6237\u7AEF\u8BF7\u6C42\uFF0C\u66F4\u6539\u8BF7\u6C42\u7ED3\u6784\u4F53\u4FE1\u606F</li><li>\u901A\u8FC7\u4E00\u5B9A\u7684\u8D1F\u8F7D\u5747\u8861\u7B97\u6CD5\u83B7\u53D6\u4E0B\u6E38\u670D\u52A1\u5730\u5740</li><li>\u628A\u8BF7\u6C42\u53D1\u9001\u5230\u4E0B\u6E38\u670D\u52A1\u5668\uFF0C\u5E76\u83B7\u53D6\u8FD4\u56DE\u5185\u5BB9</li><li>\u5BF9\u8FD4\u56DE\u5185\u5BB9\u505A\u4E00\u4E9B\u5904\u7406\uFF0C\u7136\u540E\u8FD4\u56DE\u7ED9\u5BA2\u6237\u7AEF</li></ul></li></ul><p><img src="`+k+`" alt=""></p><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// \u4E0B\u6E38\u670D\u52A1</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//\u76D1\u542C\u5173\u95ED\u4FE1\u53F7</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// \u53CD\u5411\u4EE3\u7406\u670D\u52A1</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	proxy_addr <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:2003&quot;</span>
	port       <span class="token operator">=</span> <span class="token string">&quot;2002&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//step 1 \u89E3\u6790\u4EE3\u7406\u5730\u5740\uFF0C\u5E76\u66F4\u6539\u8BF7\u6C42\u4F53\u7684\u534F\u8BAE\u548C\u4E3B\u673A</span>
	proxy<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> proxy<span class="token punctuation">.</span>Scheme <span class="token comment">// http</span>
	r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> proxy<span class="token punctuation">.</span>Host <span class="token comment">// 127.0.0.1:2003</span>

	<span class="token comment">//step 2 \u8BF7\u6C42\u4E0B\u6E38</span>
	transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultTransport
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> transport<span class="token punctuation">.</span><span class="token function">RoundTrip</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//step 3 \u628A\u4E0B\u6E38\u8BF7\u6C42\u5185\u5BB9\u8FD4\u56DE\u7ED9\u4E0A\u6E38</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> vv <span class="token operator">:=</span> <span class="token keyword">range</span> resp<span class="token punctuation">.</span>Header <span class="token punctuation">{</span> <span class="token comment">// \u8BF7\u6C42\u5934</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> vv <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteTo</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token comment">// \u8BF7\u6C42\u4F53</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Start serving on port &quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>port<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div></details><h2 id="http\u4EE3\u7406" tabindex="-1"><a class="header-anchor" href="#http\u4EE3\u7406" aria-hidden="true">#</a> http\u4EE3\u7406</h2><h3 id="\u9700\u8981\u5B9E\u73B0\u7684\u57FA\u672C\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u9700\u8981\u5B9E\u73B0\u7684\u57FA\u672C\u529F\u80FD" aria-hidden="true">#</a> \u9700\u8981\u5B9E\u73B0\u7684\u57FA\u672C\u529F\u80FD</h3><ul><li>\u9519\u8BEF\u56DE\u8C03\u53CA\u9519\u8BEF\u65E5\u5FD7\u5904\u7406</li><li>\u66F4\u6539\u4E0B\u6E38\u670D\u52A1\u8FD4\u56DE\u5185\u5BB9</li><li>\u8D1F\u8F7D\u5747\u8861</li><li>url\u91CD\u5199</li><li>\u9650\u6D41\u3001\u7194\u65AD\u3001\u964D\u7EA7</li><li>\u6570\u636E\u7EDF\u8BA1</li><li>\u6743\u9650\u9A8C\u8BC1</li></ul><h3 id="reverseproxy-\u6807\u51C6\u5E93" tabindex="-1"><a class="header-anchor" href="#reverseproxy-\u6807\u51C6\u5E93" aria-hidden="true">#</a> ReverseProxy -- \u6807\u51C6\u5E93</h3><h4 id="\u529F\u80FD\u70B9" tabindex="-1"><a class="header-anchor" href="#\u529F\u80FD\u70B9" aria-hidden="true">#</a> \u529F\u80FD\u70B9</h4><ul><li>\u66F4\u6539\u5185\u5BB9\u652F\u6301</li><li>\u9519\u8BEF\u4FE1\u606F\u56DE\u8C03</li><li>\u652F\u6301\u81EA\u5B9A\u4E49\u8D1F\u8F7D\u5747\u8861</li><li>url\u91CD\u5199\u529F\u80FD</li><li>\u8FDE\u63A5\u6C60\u529F\u80FD</li><li>\u652F\u6301websocket\u670D\u52A1</li><li>\u652F\u6301https\u4EE3\u7406</li></ul><h4 id="reverseproxy-\u4EE3\u7406\u7684\u4E0B\u6E38\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#reverseproxy-\u4EE3\u7406\u7684\u4E0B\u6E38\u670D\u52A1" aria-hidden="true">#</a> ReverseProxy \u4EE3\u7406\u7684\u4E0B\u6E38\u670D\u52A1</h4><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//\u76D1\u542C\u5173\u95ED\u4FE1\u53F7</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div></details><h4 id="reverseproxy-\u7B80\u5355\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#reverseproxy-\u7B80\u5355\u4F7F\u7528" aria-hidden="true">#</a> ReverseProxy \u7B80\u5355\u4F7F\u7528</h4><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:2002/xxx --&gt; 127.0.0.1:2003/base/xxx</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> httputil<span class="token punctuation">.</span><span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></details><h4 id="reverseproxy-\u4FEE\u6539\u8FD4\u56DE\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#reverseproxy-\u4FEE\u6539\u8FD4\u56DE\u5185\u5BB9" aria-hidden="true">#</a> ReverseProxy \u4FEE\u6539\u8FD4\u56DE\u5185\u5BB9</h4><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:2002/xxx</span>
	<span class="token comment">//127.0.0.1:2003/base/xxx</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>target <span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//http://127.0.0.1:2002/dir?name=123</span>
	<span class="token comment">//RayQuery: name=123</span>
	<span class="token comment">//Scheme: http</span>
	<span class="token comment">//Host: 127.0.0.1:2002</span>
	targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>

		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">//target.Path : /base</span>
		<span class="token comment">//req.URL.Path : /dir</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>res <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			<span class="token comment">//return errors.New(&quot;error statusCode&quot;)</span>
            <span class="token comment">// \u83B7\u53D6\u4E0B\u6E38\u670D\u52A1\u7684\u54CD\u5E94\u5185\u5BB9</span>
			oldPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
            <span class="token comment">// \u4FEE\u6539\u4E0B\u6E38\u670D\u52A1\u7684\u54CD\u5E94\u5185\u5BB9</span>
			newPayLoad <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;hello &quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>oldPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// \u56DE\u5199\u54CD\u5E94\u4F53\u5185\u5BB9</span>
			res<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// \u91CD\u7F6E\u54CD\u5E94\u4F53\u957F\u5EA6</span>
			res<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span>
			res<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	errorHandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>res http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>Director<span class="token punctuation">:</span> director<span class="token punctuation">,</span> ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">:</span> errorHandler<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div></details><h4 id="reverseproxy-\u7279\u6B8A\u8BF7\u6C42\u5934-connection" tabindex="-1"><a class="header-anchor" href="#reverseproxy-\u7279\u6B8A\u8BF7\u6C42\u5934-connection" aria-hidden="true">#</a> ReverseProxy \u7279\u6B8A\u8BF7\u6C42\u5934 -- Connection</h4><ul><li>\u6807\u8BB0<strong>\u8BF7\u6C42\u53D1\u9001\u65B9</strong>\u4E0E<strong>\u7B2C\u4E00\u4EE3\u7406</strong>\u7684\u72B6\u6001</li><li>\u51B3\u5B9A\u5F53\u524D\u4E8B\u52A1\u5B8C\u6210\u540E\uFF0C\u662F\u5426\u4F1A\u5173\u95ED\u7F51\u7EDC <ul><li>Connection\uFF1Akeep-alive //\u4E0D\u5173\u95ED\u7F51\u7EDC</li><li>Connection\uFF1Aclose //\u5173\u95ED\u7F51\u7EDC</li><li>Connection\uFF1AUpgrade //\u534F\u8BAE\u5347\u7EA7</li></ul></li></ul><p><img src="`+b+'" alt=""></p><h4 id="reverseproxy-\u7279\u6B8A\u8BF7\u6C42\u54CD\u5E94\u5934-te\u3001trailer" tabindex="-1"><a class="header-anchor" href="#reverseproxy-\u7279\u6B8A\u8BF7\u6C42\u54CD\u5E94\u5934-te\u3001trailer" aria-hidden="true">#</a> ReverseProxy \u7279\u6B8A\u8BF7\u6C42\u54CD\u5E94\u5934 -- TE\u3001Trailer</h4><ul><li>TE <ul><li>\u8BF7\u6C42\u5934</li><li>\u8868\u793A\u5E0C\u671B\u4F7F\u7528\u7684\u4F20\u8F93\u7F16\u7801\u7C7B\u578B</li><li>\u5982\uFF1ATE: trailers, deflate;q=0.5\uFF0C\u8868\u793A\u671F\u671B\u5728\u91C7\u7528\u5206\u5757\u4F20\u8F93\u7F16\u7801\u54CD\u5E94\u4E2D\u63A5\u6536\u6302\u8F7D\u5B57\u6BB5, zlib\u7F16\u7801, 0.5\u4F18\u5148\u7EA7\u6392\u5E8F</li></ul></li><li>Trailer <ul><li>\u54CD\u5E94\u5934</li><li>\u5141\u8BB8\u53D1\u9001\u65B9\u5728\u6D88\u606F\u540E\u9762\u6DFB\u52A0\u989D\u5916\u7684\u5143\u4FE1\u606F</li><li>\u5982\uFF1ATrailer: Expires, \u8868\u793AExpires \u5C06\u51FA\u73B0\u5728\u5206\u5757\u4FE1\u606F\u7684\u7ED3\u5C3E</li></ul></li></ul><h4 id="\u7B2C\u4E00\u4EE3\u7406\u53BB\u9664\u6807\u51C6\u7684\u9010\u6BB5\u4F20\u8F93\u5934" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E00\u4EE3\u7406\u53BB\u9664\u6807\u51C6\u7684\u9010\u6BB5\u4F20\u8F93\u5934" aria-hidden="true">#</a> \u7B2C\u4E00\u4EE3\u7406\u53BB\u9664\u6807\u51C6\u7684\u9010\u6BB5\u4F20\u8F93\u5934</h4><ul><li>\u9010\u6BB5\u4F20\u8F93\u5934\u90FD\u9700\u8981\u5728 Connection \u5934\u4E2D\u5217\u51FA</li><li>\u7B2C\u4E00\u4EE3\u7406\u77E5\u9053\u5FC5\u987B\u5904\u7406\u5B83\u4EEC\uFF08\u5982\u534F\u8BAE\u5347\u7EA7\uFF09\uFF0C\u5E76\u4E14\u4E0D\u8F6C\u53D1\u5B83\u3002</li><li>\u9010\u6BB5\u4F20\u8F93\u5934 <ul><li>Keep-Alive</li><li>Transfer-Encoding</li><li>TE</li><li>Connection</li><li>Trailer</li><li>Upgrade</li><li>Proxy-Authorization</li><li>Proxy-Authenticate</li></ul></li></ul><h4 id="\u7279\u6B8Astatuscode" tabindex="-1"><a class="header-anchor" href="#\u7279\u6B8Astatuscode" aria-hidden="true">#</a> \u7279\u6B8AStatusCode</h4><ul><li><strong>100:</strong> \u8868\u793A\u76EE\u524D\u4E00\u5207\u6B63\u5E38\uFF0C\u5BA2\u6237\u7AEF\u53EF\u4EE5\u7EE7\u7EED\u8BF7\u6C42 <ul><li>\u5BA2\u6237\u7AEF\u8981POST\u7684\u6570\u636E\u5927\u4E8E1024\u5B57\u8282\u7684\u65F6\u5019</li><li>\u5BA2\u6237\u7AEF\u4E0D\u4F1A\u76F4\u63A5\u5C31\u53D1\u8D77POST\u8BF7\u6C42\uFF0C\u800C\u662F\u5206\u4E3A\u4E24\u6B65 <ul><li>\u53D1\u9001\u4E00\u4E2A\u8BF7\u6C42\uFF0C\u5305\u542B\u4E00\u4E2AExpect: 100-continue,\u8BE2\u95EEServer\u662F\u5426\u613F\u610F\u63A5\u6536\u6570\u636E</li><li>\u63A5\u6536\u5230Server\u8FD4\u56DE\u7684100-continue\u5E94\u7B54\u4EE5\u540E\uFF0C\u8FD4\u56DE100\u72B6\u6001\uFF0C\u624D\u628A\u6570\u636EPOST\u7ED9Server</li></ul></li></ul></li><li><strong>101:</strong> \u670D\u52A1\u7AEF\u53D1\u9001\u7ED9\u5BA2\u6237\u7AEF\u5347\u7EA7\u534F\u8BAE\u7684\u8BF7\u6C42</li></ul><p><img src="'+m+'" alt=""></p><h4 id="\u8BF7\u6C42\u5934-x-forward-for-\u548C-x-real-ip" tabindex="-1"><a class="header-anchor" href="#\u8BF7\u6C42\u5934-x-forward-for-\u548C-x-real-ip" aria-hidden="true">#</a> \u8BF7\u6C42\u5934 X-Forward-For \u548C X-Real-Ip</h4><ul><li>X-Forwarded-For <ul><li>\u8BB0\u5F55\u6700\u540E\u76F4\u8FDE\u5B9E\u9645\u670D\u52A1\u5668\u4E4B\u524D\u7684\u6574\u4E2A\u4EE3\u7406\u8FC7\u7A0B</li><li>\u53EF\u80FD\u4F1A\u88AB\u4F2A\u9020</li></ul></li></ul><p><img src="'+d+'" alt=""></p><ul><li>X-Real-IP <ul><li>\u8BF7\u6C42\u5B9E\u9645\u670D\u52A1\u5668\u7684IP</li><li>\u6BCF\u8FC7\u4E00\u5C42\u4EE3\u7406\u90FD\u4F1A\u88AB\u8986\u76D6\u6389\uFF0C\u53EA\u9700\u7B2C\u4E00\u4EE3\u7406\u8BBE\u7F6E\u8F6C\u53D1</li><li>\u4E0D\u4F1A\u88AB\u4F4D\u7F6E</li></ul></li></ul><p><img src="'+g+`" alt=""></p><h5 id="\u4EE3\u7801\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#\u4EE3\u7801\u5B9E\u73B0" aria-hidden="true">#</a> \u4EE3\u7801\u5B9E\u73B0</h5><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><ul><li>\u771F\u5B9E\u670D\u52A1</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// real_server/main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//\u76D1\u542C\u5173\u95ED\u4FE1\u53F7</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/test_http_string/test_http_string/aaa&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>TimeoutHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	<span class="token comment">//fmt.Println(req.Host)</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	realIP <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;RemoteAddr=%s,X-Forwarded-For=%v,X-Real-Ip=%v\\n&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Real-Ip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	header<span class="token operator">:=</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;headers =%v\\n&quot;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> realIP<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> header<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">TimeoutHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;timeout handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><ul><li>\u7B2C\u4E8C\u5C42\u4EE3\u7406</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// reverse_proxy/main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;compress/gzip&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//rs1 := &quot;http://www.baidu.com&quot;</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//rs2 := &quot;http://www.baidu.com&quot;</span>
	rs2 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2004&quot;</span>
	url2<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs2<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>url1<span class="token punctuation">,</span> url2<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> transport <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
	DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//\u8FDE\u63A5\u8D85\u65F6</span>
		KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//\u957F\u8FDE\u63A5\u8D85\u65F6\u65F6\u95F4</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
	MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">//\u6700\u5927\u7A7A\u95F2\u8FDE\u63A5</span>
	IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//\u7A7A\u95F2\u8D85\u65F6\u65F6\u95F4</span>
	TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//tls\u63E1\u624B\u8D85\u65F6\u65F6\u95F4</span>
	ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//100-continue \u8D85\u65F6\u65F6\u95F4</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>targets <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//\u8BF7\u6C42\u534F\u8C03\u8005</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//\u968F\u673A\u8D1F\u8F7D\u5747\u8861</span>
		targetIndex <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span>
		target <span class="token operator">:=</span> targets<span class="token punctuation">[</span>targetIndex<span class="token punctuation">]</span>
		targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">//todo \u90E8\u5206\u7AE0\u8282\u8865\u51451</span>
		<span class="token comment">//todo \u5F53\u5BF9\u57DF\u540D(\u975E\u5185\u7F51)\u53CD\u5411\u4EE3\u7406\u65F6\u9700\u8981\u8BBE\u7F6E\u6B64\u9879\u3002\u5F53\u4F5C\u540E\u7AEF\u53CD\u5411\u4EE3\u7406\u65F6\u4E0D\u9700\u8981</span>
		req<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">// url\u5730\u5740\u91CD\u5199\uFF1A\u91CD\u5199\u524D\uFF1A/aa \u91CD\u5199\u540E\uFF1A/base/aa</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//\u53EA\u5728\u7B2C\u4E00\u4EE3\u7406\u4E2D\u8BBE\u7F6E\u6B64header\u5934</span>
		<span class="token comment">//req.Header.Set(&quot;X-Real-Ip&quot;, req.RemoteAddr)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//\u66F4\u6539\u5185\u5BB9</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">//\u8BF7\u6C42\u4EE5\u4E0B\u547D\u4EE4\uFF1Acurl &#39;http://127.0.0.1:2002/error&#39;</span>
		<span class="token comment">//todo \u90E8\u5206\u7AE0\u8282\u529F\u80FD\u8865\u51452</span>
		<span class="token comment">//todo \u517C\u5BB9websocket</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Upgrade&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">var</span> payload <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		<span class="token keyword">var</span> readErr <span class="token builtin">error</span>

		<span class="token comment">//todo \u90E8\u5206\u7AE0\u8282\u529F\u80FD\u8865\u51453</span>
		<span class="token comment">//todo \u517C\u5BB9gzip\u538B\u7F29</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			gr<span class="token punctuation">,</span> err <span class="token operator">:=</span> gzip<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			payload<span class="token punctuation">,</span> readErr <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>gr<span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			payload<span class="token punctuation">,</span> readErr <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> readErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> readErr
		<span class="token punctuation">}</span>

		<span class="token comment">//\u5F02\u5E38\u8BF7\u6C42\u65F6\u8BBE\u7F6EStatusCode</span>
		<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;StatusCode error:&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//todo \u90E8\u5206\u7AE0\u8282\u529F\u80FD\u8865\u51454</span>
		<span class="token comment">//todo \u56E0\u4E3A\u9884\u8BFB\u4E86\u6570\u636E\u6240\u4EE5\u5185\u5BB9\u91CD\u65B0\u56DE\u5199</span>
		resp<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//\u9519\u8BEF\u56DE\u8C03 \uFF1A\u5173\u95EDreal_server\u65F6\u6D4B\u8BD5\uFF0C\u9519\u8BEF\u56DE\u8C03</span>
	errFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;ErrorHandler error:&quot;</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>
		Director<span class="token punctuation">:</span>       director<span class="token punctuation">,</span>
		Transport<span class="token punctuation">:</span>      transport<span class="token punctuation">,</span>
		ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span>
		ErrorHandler<span class="token punctuation">:</span>   errFunc<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><ul><li>\u7B2C\u4E00\u5C42\u4EE3\u7406</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// reverse_proxy_level1/main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2001&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2002&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>url1<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> transport <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
	DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//\u8FDE\u63A5\u8D85\u65F6</span>
		KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//\u957F\u8FDE\u63A5\u8D85\u65F6\u65F6\u95F4</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
	MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">//\u6700\u5927\u7A7A\u95F2\u8FDE\u63A5</span>
	IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//\u7A7A\u95F2\u8D85\u65F6\u65F6\u95F4</span>
	TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//tls\u63E1\u624B\u8D85\u65F6\u65F6\u95F4</span>
	ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//100-continue \u8D85\u65F6\u65F6\u95F4</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>targets <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//\u8BF7\u6C42\u534F\u8C03\u8005</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//\u968F\u673A\u8D1F\u8F7D\u5747\u8861</span>
		targetIndex <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span>
		target <span class="token operator">:=</span> targets<span class="token punctuation">[</span>targetIndex<span class="token punctuation">]</span>
		targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">// url\u5730\u5740\u91CD\u5199\uFF1A\u91CD\u5199\u524D\uFF1A/aa \u91CD\u5199\u540E\uFF1A/base/aa</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//\u53EA\u5728\u7B2C\u4E00\u4EE3\u7406\u4E2D\u8BBE\u7F6E\u6B64header\u5934</span>
		req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;X-Real-Ip&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//\u66F4\u6539\u5185\u5BB9</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">//\u8BF7\u6C42\u4EE5\u4E0B\u547D\u4EE4\uFF1Acurl &#39;http://127.0.0.1:2002/error&#39;</span>
		<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			<span class="token comment">//\u83B7\u53D6\u5185\u5BB9</span>
			oldPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token comment">//\u8FFD\u52A0\u5185\u5BB9</span>
			newPayload <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;StatusCode error:&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>oldPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//\u9519\u8BEF\u56DE\u8C03 \uFF1A\u5173\u95EDreal_server\u65F6\u6D4B\u8BD5\uFF0C\u9519\u8BEF\u56DE\u8C03</span>
	errFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;ErrorHandler error:&quot;</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>
		Director<span class="token punctuation">:</span>       director<span class="token punctuation">,</span>
		Transport<span class="token punctuation">:</span>      transport<span class="token punctuation">,</span>
		ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span>
		ErrorHandler<span class="token punctuation">:</span>   errFunc<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><ul><li>\u8FD0\u884C\u7ED3\u679C</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token string">&#39;http://127.0.0.1:2001/base&#39;</span>
http://127.0.0.1:2004/base
<span class="token assign-left variable">RemoteAddr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:55561,X-Forwarded-For<span class="token operator">=</span><span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1,X-Real-Ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1:55557
headers <span class="token operator">=</span>map<span class="token punctuation">[</span>Accept:<span class="token punctuation">[</span>text/html,application/xhtml+xml,application/xml<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,image/webp,image/apng,*/*<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,application/signed-exchange<span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span>b3<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">]</span> Accept-Encoding:<span class="token punctuation">[</span>gzip, deflate, br<span class="token punctuation">]</span> Accept-Language:<span class="token punctuation">[</span>zh-CN,zh<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,en<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,en-GB<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.7</span>,en-US<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">]</span> Sec-Ch-Ua:<span class="token punctuation">[</span><span class="token string">&quot; Not A;Brand&quot;</span><span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token string">&quot;99&quot;</span>, <span class="token string">&quot;Chromium&quot;</span><span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token string">&quot;99&quot;</span>, <span class="token string">&quot;Microsoft Edge&quot;</span><span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token string">&quot;99&quot;</span><span class="token punctuation">]</span> Sec-Ch-Ua-Mobile:<span class="token punctuation">[</span>?0<span class="token punctuation">]</span> Sec-Ch-Ua-Platform:<span class="token punctuation">[</span><span class="token string">&quot;Windows&quot;</span><span class="token punctuation">]</span> Sec-Fetch-Dest:<span class="token punctuation">[</span>document<span class="token punctuation">]</span> Sec-Fetch-Mode:<span class="token punctuation">[</span>navigate<span class="token punctuation">]</span> Sec-Fetch-Site:<span class="token punctuation">[</span>none<span class="token punctuation">]</span> Sec-Fetch-User:<span class="token punctuation">[</span>?1<span class="token punctuation">]</span> Upgrade-Insecure-Requests:<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> User-Agent:<span class="token punctuation">[</span>Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/99.0.4844.74 Safari/537.36 Edg/99.0.1150.46<span class="token punctuation">]</span> X-Forwarded-For:<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1<span class="token punctuation">]</span> X-Real-Ip:<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1:55557<span class="token punctuation">]</span><span class="token punctuation">]</span>
$ <span class="token function">curl</span> -H <span class="token string">&#39;X-Forwarded-For: 2.2.2.2&#39;</span> <span class="token string">&#39;http://127.0.0.1:2001/base&#39;</span>
http://127.0.0.1:2004/base
<span class="token assign-left variable">RemoteAddr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:55886,X-Forwarded-For<span class="token operator">=</span><span class="token number">2.2</span>.2.2, <span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1,X-Real-Ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1:55596
headers <span class="token operator">=</span>map<span class="token punctuation">[</span>Accept:<span class="token punctuation">[</span>*/*<span class="token punctuation">]</span> Accept-Encoding:<span class="token punctuation">[</span>gzip, deflate, br<span class="token punctuation">]</span> Content-Length:<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span> Content-Type:<span class="token punctuation">[</span>application/json<span class="token punctuation">]</span> Postman-Token:<span class="token punctuation">[</span>3043f404-069c-4c62-97a8-c18da86e2a84<span class="token punctuation">]</span> User-Agent:<span class="token punctuation">[</span>PostmanRuntime/7.28.4<span class="token punctuation">]</span> X-Forwarded-For:<span class="token punctuation">[</span><span class="token number">2.2</span>.2.2, <span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1<span class="token punctuation">]</span> X-Real-Ip:<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1:55596<span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line">\xA0</div><br><br><br><div class="highlight-line">\xA0</div><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></details><h3 id="\u56DB\u79CD\u8D1F\u8F7D\u5747\u8861\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u56DB\u79CD\u8D1F\u8F7D\u5747\u8861\u7B56\u7565" aria-hidden="true">#</a> \u56DB\u79CD\u8D1F\u8F7D\u5747\u8861\u7B56\u7565</h3><ul><li><strong>\u968F\u673A\u8D1F\u8F7D:</strong> \u968F\u673A\u6311\u9009\u76EE\u6807\u670D\u52A1\u5668IP</li><li><strong>\u8F6E\u8BE2\u8D1F\u8F7D:</strong> ABC\u4E09\u53F0\u670D\u52A1\u5668\uFF0CABCABC\u4F9D\u6B21\u8F6E\u8BE2</li><li><strong>\u52A0\u6743\u8D1F\u8F7D:</strong> \u7ED9\u76EE\u6807\u8BBE\u7F6E\u8BBF\u95EE\u6743\u91CD\uFF0C\u6309\u7167\u6743\u91CD\u8F6E\u8BE2</li><li><strong>\u4E00\u81F4\u6027hash\u8D1F\u8F7D:</strong> \u8BF7\u6C42\u56FA\u5B9AURL\u8BBF\u95EE\u6307\u5B9AIP</li></ul><h4 id="\u968F\u673A\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u968F\u673A\u7B56\u7565" aria-hidden="true">#</a> \u968F\u673A\u7B56\u7565</h4><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> RandomBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>r<span class="token punctuation">.</span>curIndex<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestRandomBalance</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>RandomBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><ul><li>\u8FD0\u884C\u7ED3\u679C</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run TestRandomBalance
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2004
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.035s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></details><h4 id="\u8F6E\u8BE2\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u8F6E\u8BE2\u7B56\u7565" aria-hidden="true">#</a> \u8F6E\u8BE2\u7B56\u7565</h4><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> RoundRobinBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	lens <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token comment">//5</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>curIndex <span class="token operator">&gt;=</span> lens <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	curAddr <span class="token operator">:=</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>r<span class="token punctuation">.</span>curIndex<span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> lens
	<span class="token keyword">return</span> curAddr
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Test_main</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>RoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><ul><li>\u8FD0\u884C\u7ED3\u679C</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run Test_main
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2006
<span class="token number">127.0</span>.0.1:2007
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2006
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.039s

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details><h4 id="\u52A0\u6743\u8F6E\u8BE2\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u52A0\u6743\u8F6E\u8BE2\u7B56\u7565" aria-hidden="true">#</a> \u52A0\u6743\u8F6E\u8BE2\u7B56\u7565</h4><div class="custom-container tip"><p class="custom-container-title">\u5B9E\u73B0\u539F\u7406</p><p><strong>ServerA=4 | ServerB=3 | ServerC=2</strong></p></div><table><thead><tr><th>\u8BF7\u6C42\u6B21\u6570</th><th>\u8BF7\u6C42\u524DcurrentWeight</th><th>\u9009\u4E2D\u7684\u8282\u70B9</th><th>\u8BF7\u6C42\u540EcurrentWeight</th></tr></thead><tbody><tr><td>1</td><td>[ServerA=4, ServerB=3, ServerC=2]</td><td>ServerA</td><td>[ServerA=-1, ServerB=6, ServerC=4]</td></tr><tr><td>2</td><td>[ServerA=-1, ServerB=6, ServerC=4]</td><td>ServerB</td><td>[ServerA=3, ServerB=0, ServerC=6]</td></tr><tr><td>3</td><td>[ServerA=3, ServerB=0, ServerC=6]</td><td>ServerC</td><td>[ServerA=7, ServerB=3, ServerC=-1]</td></tr><tr><td>4</td><td>[ServerA=7, ServerB=3, ServerC=-1]</td><td>ServerA</td><td>[ServerA=2, ServerB=6, ServerC=1]</td></tr><tr><td>5</td><td>[ServerA=2, ServerB=6, ServerC=1]</td><td>ServerB</td><td>[ServerA=6, ServerB=0, ServerC=3]</td></tr><tr><td>6</td><td>[ServerA=6, ServerB=0, ServerC=3]</td><td>ServerA</td><td>[ServerA=1, ServerB=3, ServerC=5]</td></tr><tr><td>7</td><td>[ServerA=1, ServerB=3, ServerC=5]</td><td>ServerC</td><td>[ServerA=5, ServerB=6, ServerC=-2]</td></tr><tr><td>8</td><td>[ServerA=5, ServerB=6, ServerC=-2]</td><td>ServerB</td><td>[ServerA=9, ServerB=0, ServerC=0]</td></tr><tr><td>9</td><td>[ServerA=9, ServerB=0, ServerC=0]</td><td>ServerA</td><td>[ServerA=4, ServerB=3, ServerC=2]</td></tr></tbody></table><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> WeightRoundRobinBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>WeightNode
	rsw      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> WeightNode <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	addr            <span class="token builtin">string</span>
	weight          <span class="token builtin">int</span> <span class="token comment">//\u6743\u91CD\u503C</span>
	currentWeight   <span class="token builtin">int</span> <span class="token comment">//\u8282\u70B9\u5F53\u524D\u6743\u91CD</span>
	effectiveWeight <span class="token builtin">int</span> <span class="token comment">//\u6709\u6548\u6743\u91CD</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>WeightRoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len need 2&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	parInt<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	node <span class="token operator">:=</span> <span class="token operator">&amp;</span>WeightNode<span class="token punctuation">{</span>addr<span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token function">int</span><span class="token punctuation">(</span>parInt<span class="token punctuation">)</span><span class="token punctuation">}</span>
	node<span class="token punctuation">.</span>effectiveWeight <span class="token operator">=</span> node<span class="token punctuation">.</span>weight
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>WeightRoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	total <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">var</span> best <span class="token operator">*</span>WeightNode
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		w <span class="token operator">:=</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token comment">//step 1 \u7EDF\u8BA1\u6240\u6709\u6709\u6548\u6743\u91CD\u4E4B\u548C</span>
		total <span class="token operator">+=</span> w<span class="token punctuation">.</span>effectiveWeight

		<span class="token comment">//step 2 \u53D8\u66F4\u8282\u70B9\u4E34\u65F6\u6743\u91CD\u4E3A\u7684\u8282\u70B9\u4E34\u65F6\u6743\u91CD+\u8282\u70B9\u6709\u6548\u6743\u91CD</span>
		w<span class="token punctuation">.</span>currentWeight <span class="token operator">+=</span> w<span class="token punctuation">.</span>effectiveWeight

		<span class="token comment">//step 3 \u6709\u6548\u6743\u91CD\u9ED8\u8BA4\u4E0E\u6743\u91CD\u76F8\u540C\uFF0C\u901A\u8BAF\u5F02\u5E38\u65F6-1, \u901A\u8BAF\u6210\u529F+1\uFF0C\u76F4\u5230\u6062\u590D\u5230weight\u5927\u5C0F</span>
		<span class="token keyword">if</span> w<span class="token punctuation">.</span>effectiveWeight <span class="token operator">&lt;</span> w<span class="token punctuation">.</span>weight <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span>effectiveWeight<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//step 4 \u9009\u62E9\u6700\u5927\u4E34\u65F6\u6743\u91CD\u70B9\u8282\u70B9</span>
		<span class="token keyword">if</span> best <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>currentWeight <span class="token operator">&gt;</span> best<span class="token punctuation">.</span>currentWeight <span class="token punctuation">{</span>
			best <span class="token operator">=</span> w
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> best <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//step 5 \u53D8\u66F4\u4E34\u65F6\u6743\u91CD\u4E3A \u4E34\u65F6\u6743\u91CD-\u6709\u6548\u6743\u91CD\u4E4B\u548C</span>
	best<span class="token punctuation">.</span>currentWeight <span class="token operator">-=</span> total
	<span class="token keyword">return</span> best<span class="token punctuation">.</span>addr
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">TestLB</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>WeightRoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><ul><li>\u8FD0\u884C\u7ED3\u679C</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run TestLB
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.039s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></details><h4 id="\u4E00\u81F4\u6027\u54C8\u5E0C\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u4E00\u81F4\u6027\u54C8\u5E0C\u7B56\u7565" aria-hidden="true">#</a> \u4E00\u81F4\u6027\u54C8\u5E0C\u7B56\u7565</h4>`,53),S={class:"custom-container tip"},R=n("p",{class:"custom-container-title"},"\u4E00\u81F4\u6027\u54C8\u5E0C\u6307\u6807",-1),P=n("p",null,"\u5355\u8C03\u6027 \u3001 \u5E73\u8861\u6027\u3001\u5206\u6563\u6027\u3001\u8D1F\u8F7D\u3001\u5E73\u6ED1\u6027",-1),A={href:"https://zhuanlan.zhihu.com/p/146011745",target:"_blank",rel:"noopener noreferrer"},_=s("\u4E00\u81F4\u6027hash\u73AF\u539F\u7406"),H=a(`<details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;hash/crc32&quot;</span>
	<span class="token string">&quot;sort&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Hash <span class="token keyword">func</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span>

<span class="token keyword">type</span> UInt32Slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConsistentHashBanlance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mux      sync<span class="token punctuation">.</span>RWMutex
	hash     Hash
	replicas <span class="token builtin">int</span>               <span class="token comment">//\u590D\u5236\u56E0\u5B50</span>
	keys     UInt32Slice       <span class="token comment">//\u5DF2\u6392\u5E8F\u7684\u8282\u70B9hash\u5207\u7247</span>
	hashMap  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint32</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//\u8282\u70B9\u54C8\u5E0C\u548CKey\u7684map,\u952E\u662Fhash\u503C\uFF0C\u503C\u662F\u8282\u70B9key</span>

	<span class="token comment">//\u89C2\u5BDF\u4E3B\u4F53</span>
	conf LoadBalanceConf
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span>replicas <span class="token builtin">int</span><span class="token punctuation">,</span> fn Hash<span class="token punctuation">)</span> <span class="token operator">*</span>ConsistentHashBanlance <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConsistentHashBanlance<span class="token punctuation">{</span>
		replicas<span class="token punctuation">:</span> replicas<span class="token punctuation">,</span>
		hash<span class="token punctuation">:</span>     fn<span class="token punctuation">,</span>
		hashMap<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint32</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>hash <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">//\u6700\u591A32\u4F4D,\u4FDD\u8BC1\u662F\u4E00\u4E2A2^32-1\u73AF</span>
		m<span class="token punctuation">.</span>hash <span class="token operator">=</span> crc32<span class="token punctuation">.</span>ChecksumIEEE
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> m
<span class="token punctuation">}</span>

<span class="token comment">// \u9A8C\u8BC1\u662F\u5426\u4E3A\u7A7A</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add \u65B9\u6CD5\u7528\u6765\u6DFB\u52A0\u7F13\u5B58\u8282\u70B9\uFF0C\u53C2\u6570\u4E3A\u8282\u70B9key\uFF0C\u6BD4\u5982\u4F7F\u7528IP</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// \u7ED3\u5408\u590D\u5236\u56E0\u5B50\u8BA1\u7B97\u6240\u6709\u865A\u62DF\u8282\u70B9\u7684hash\u503C\uFF0C\u5E76\u5B58\u5165m.keys\u4E2D\uFF0C\u540C\u65F6\u5728m.hashMap\u4E2D\u4FDD\u5B58\u54C8\u5E0C\u503C\u548Ckey\u7684\u6620\u5C04</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>replicas<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		hash <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>hashMap<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> addr
	<span class="token punctuation">}</span>
	<span class="token comment">// \u5BF9\u6240\u6709\u865A\u62DF\u8282\u70B9\u7684\u54C8\u5E0C\u503C\u8FDB\u884C\u6392\u5E8F\uFF0C\u65B9\u4FBF\u4E4B\u540E\u8FDB\u884C\u4E8C\u5206\u67E5\u627E</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get \u65B9\u6CD5\u6839\u636E\u7ED9\u5B9A\u7684\u5BF9\u8C61\u83B7\u53D6\u6700\u9760\u8FD1\u5B83\u7684\u90A3\u4E2A\u8282\u70B9</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;node is empty&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	hash <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// \u901A\u8FC7\u4E8C\u5206\u67E5\u627E\u83B7\u53D6\u6700\u4F18\u8282\u70B9\uFF0C\u7B2C\u4E00\u4E2A&quot;\u670D\u52A1\u5668hash&quot;\u503C\u5927\u4E8E&quot;\u6570\u636Ehash&quot;\u503C\u7684\u5C31\u662F\u6700\u4F18&quot;\u670D\u52A1\u5668\u8282\u70B9&quot;</span>
	idx <span class="token operator">:=</span> sort<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> c<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> hash <span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// \u5982\u679C\u67E5\u627E\u7ED3\u679C \u5927\u4E8E \u670D\u52A1\u5668\u8282\u70B9\u54C8\u5E0C\u6570\u7EC4\u7684\u6700\u5927\u7D22\u5F15\uFF0C\u8868\u793A\u6B64\u65F6\u8BE5\u5BF9\u8C61\u54C8\u5E0C\u503C\u4F4D\u4E8E\u6700\u540E\u4E00\u4E2A\u8282\u70B9\u4E4B\u540E\uFF0C\u90A3\u4E48\u653E\u5165\u7B2C\u4E00\u4E2A\u8282\u70B9\u4E2D</span>
	<span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		idx <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>hashMap<span class="token punctuation">[</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestNewConsistentHashBanlance</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	<span class="token comment">//url hash</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/getinfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/getinfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/changepwd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">//ip hash</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><ul><li>\u8FD0\u884C\u7ED3\u679C</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run TestNewConsistentHashBanlance
<span class="token number">127.0</span>.0.1:2004 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2005 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2004 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2005 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2007 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2003 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2007 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.039s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></details><h3 id="\u4E2D\u95F4\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u4E2D\u95F4\u4EF6" aria-hidden="true">#</a> \u4E2D\u95F4\u4EF6</h3><h3 id="\u9650\u6D41\u3001\u7194\u65AD\u3001\u964D\u7EA7" tabindex="-1"><a class="header-anchor" href="#\u9650\u6D41\u3001\u7194\u65AD\u3001\u964D\u7EA7" aria-hidden="true">#</a> \u9650\u6D41\u3001\u7194\u65AD\u3001\u964D\u7EA7</h3><h4 id="\u9650\u6D41\u5668-time-rate" tabindex="-1"><a class="header-anchor" href="#\u9650\u6D41\u5668-time-rate" aria-hidden="true">#</a> \u9650\u6D41\u5668 time/rate</h4><h5 id="\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#\u4ECB\u7ECD" aria-hidden="true">#</a> \u4ECB\u7ECD</h5>`,5),C=n("li",null,"\u9650\u6D41\u5668\u662F\u540E\u53F0\u670D\u52A1\u4E2D\u7684\u975E\u5E38\u91CD\u8981\u7684\u7EC4\u4EF6\uFF0C\u53EF\u4EE5\u7528\u6765\u9650\u5236\u8BF7\u6C42\u901F\u7387\uFF0C\u4FDD\u62A4\u670D\u52A1\uFF0C\u4EE5\u514D\u670D\u52A1\u8FC7\u8F7D\u3002",-1),L=n("li",null,"\u9650\u6D41\u5668\u7684\u5B9E\u73B0\u65B9\u6CD5\u6709\u5F88\u591A\u79CD\uFF0C\u4F8B\u5982\u6ED1\u52A8\u7A97\u53E3\u6CD5\u3001Token Bucket\u3001Leaky Bucket \u7B49\u3002",-1),N=n("li",null,[s("\u5176\u5B9E Golang \u6807\u51C6\u5E93\u4E2D\u5C31\u81EA\u5E26\u4E86\u9650\u6D41\u7B97\u6CD5\u7684\u5B9E\u73B0\uFF0C\u5373 "),n("code",null,"golang.org/x/time/rate"),s("\u3002\u8BE5\u9650\u6D41\u5668\u662F\u57FA\u4E8E "),n("strong",null,"Token Bucket(\u4EE4\u724C\u6876)"),s(" \u5B9E\u73B0\u7684\u3002")],-1),W=n("li",null,"\u7B80\u5355\u6765\u8BF4\uFF0C\u4EE4\u724C\u6876\u5C31\u662F\u60F3\u8C61\u6709\u4E00\u4E2A\u56FA\u5B9A\u5927\u5C0F\u7684\u6876\uFF0C\u7CFB\u7EDF\u4F1A\u4EE5\u6052\u5B9A\u901F\u7387\u5411\u6876\u4E2D\u653E Token\uFF0C\u6876\u6EE1\u5219\u6682\u65F6\u4E0D\u653E\u3002\u800C\u7528\u6237\u5219\u4ECE\u6876\u4E2D\u53D6 Token\uFF0C\u5982\u679C\u6709\u5269\u4F59 Token \u5C31\u53EF\u4EE5\u4E00\u76F4\u53D6\u3002\u5982\u679C\u6CA1\u6709\u5269\u4F59 Token\uFF0C\u5219\u9700\u8981\u7B49\u5230\u7CFB\u7EDF\u4E2D\u88AB\u653E\u7F6E\u4E86 Token \u624D\u884C\u3002",-1),T={href:"https://www.cyhone.com/articles/usage-of-golang-rate/",target:"_blank",rel:"noopener noreferrer"},B=s("API\u4F7F\u7528\u8BF4\u660E"),U=a(`<h5 id="\u4EE3\u7801\u5B9E\u73B0-1" tabindex="-1"><a class="header-anchor" href="#\u4EE3\u7801\u5B9E\u73B0-1" aria-hidden="true">#</a> \u4EE3\u7801\u5B9E\u73B0</h5><details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;golang.org/x/time/rate&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRateLimiter</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l <span class="token operator">:=</span> rate<span class="token punctuation">.</span><span class="token function">NewLimiter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;limit: %f, burst: %d&quot;</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Burst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//\u963B\u585E\u7B49\u5F85\u76F4\u5230\uFF0C\u53D6\u5230\u4E00\u4E2Atoken</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;before Wait&quot;</span><span class="token punctuation">)</span>
		c<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;limiter wait err:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;after Wait&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//\u8FD4\u56DE\u9700\u8981\u7B49\u5F85\u591A\u4E45\u624D\u6709\u65B0\u7684token,\u8FD9\u6837\u5C31\u53EF\u4EE5\u7B49\u5F85\u6307\u5B9A\u65F6\u95F4\u6267\u884C\u4EFB\u52A1</span>
		r <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Reserve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;reserve Delay:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">//\u5224\u65AD\u5F53\u524D\u662F\u5426\u53EF\u4EE5\u53D6\u5230token</span>
		a <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Allow:&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------------------------------------------------------------------------------&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run Test_RateLimiter
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 limit: <span class="token number">1.000000</span>, burst: <span class="token number">5</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 reserve Delay: 0s
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 Allow: <span class="token boolean">true</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 reserve Delay: 0s
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 reserve Delay: <span class="token number">990</span>.1707ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 reserve Delay: <span class="token number">987</span>.1507ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 reserve Delay: <span class="token number">994</span>.5779ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 reserve Delay: <span class="token number">993</span>.5709ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 reserve Delay: <span class="token number">992</span>.4085ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 reserve Delay: <span class="token number">993</span>.1072ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 reserve Delay: <span class="token number">994</span>.7224ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 reserve Delay: <span class="token number">985</span>.14ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 -----------------------------------------------------------------------------------------------
PASS
ok      github.com/e421083458/gateway_demo/demo/proxy/rate_limiter      <span class="token number">15</span>.357s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><ul><li>\u521D\u59CB\u5316\u9650\u6D41\u5668\u7684\u65F6\u5019\uFF0C\u6876\u4E2D\u67095\u4E2Atoken\uFF0C\u6240\u4EE5\u524D5\u6B21\u53D6\u7684\u65F6\u5019\u5C31\u76F4\u63A5\u901A\u8FC7\uFF0C\u5F53\u6876\u4E2D\u7684token\u53D6\u5B8C\u4EE5\u540E\uFF0C\u6BCF\u79D2\u53EA\u4EA7\u751F\u4E00\u4E2Atoken\uFF0C\u6240\u4EE5\u6BCF\u95F4\u9694\u4E00\u79D2\u53EA\u6709\u4E00\u4E2A\u80FD\u6210\u529F\u53D6\u5230token</li></ul></details><h4 id="\u7194\u65AD\u5668-hystrix-go" tabindex="-1"><a class="header-anchor" href="#\u7194\u65AD\u5668-hystrix-go" aria-hidden="true">#</a> \u7194\u65AD\u5668 hystrix-go</h4><h5 id="\u4ECB\u7ECD-1" tabindex="-1"><a class="header-anchor" href="#\u4ECB\u7ECD-1" aria-hidden="true">#</a> \u4ECB\u7ECD</h5><ul><li><p><strong>hystrix-go</strong> \u662F\u7194\u65AD\u3001\u964D\u7EA7\u3001\u9650\u6D41\u96C6\u6210\u7C7B\u5E93</p></li><li><p>\u7194\u65AD\u7684\u610F\u4E49\uFF1A\u7194\u65AD\u5668\u662F\u5F53\u4F9D\u8D56\u7684\u670D\u52A1\u5DF2\u7ECF\u51FA\u73B0\u6545\u969C\u65F6\uFF0C\u4E3A\u4E86\u4FDD\u8BC1\u81EA\u8EAB\u670D\u52A1\u7684\u6B63\u5E38\u8FD0\u884C\u4E0D\u5728\u8BBF\u95EE\u4F9D\u8D56\u7684\u670D\u52A1\uFF0C\u9632\u6B62\u96EA\u5D29\u6548\u5E94</p></li><li><p>\u964D\u7EA7\u7684\u610F\u4E49\uFF1A\u5F53\u670D\u52A1\u5668\u538B\u529B\u5267\u589E\u65F6\uFF0C\u6839\u636E\u4E1A\u52A1\u7B56\u7565\u964D\u7EA7\uFF0C\u4EE5\u6B64\u91CA\u653E\u670D\u52A1\u8D44\u6E90\u4FDD\u8BC1\u4E1A\u52A1\u6B63\u5E38</p></li><li><p>\u7194\u65AD\u5668\u7684\u4E09\u79CD\u72B6\u6001</p><ul><li><p><strong>\u5173\u95ED\u72B6\u6001</strong></p><ul><li>\u670D\u52A1\u6B63\u5E38\uFF0C\u7EF4\u62A4\u5931\u8D25\u7387\u7EDF\u8BA1\uFF0C\u8FBE\u5230\u5931\u8D25\u7387\u9608\u503C\u65F6\uFF0C\u8F6C\u5230\u5F00\u542F\u72B6\u6001</li></ul></li><li><p><strong>\u5F00\u542F\u72B6\u6001</strong></p><ul><li>\u670D\u52A1\u5F02\u5E38\uFF0C\u8C03\u7528fallback\u51FD\u6570\uFF0C\u4E00\u6BB5\u65F6\u95F4\u540E\uFF0C\u8FDB\u5165\u534A\u5F00\u542F\u72B6\u6001</li></ul></li><li><p><strong>\u534A\u5F00\u542F\u72B6\u6001</strong></p><ul><li>\u5C1D\u8BD5\u6062\u590D\u670D\u52A1\uFF0C\u5931\u8D25\u7387\u9AD8\u4E8E\u9608\u503C\uFF0C\u8FDB\u5165\u5F00\u542F\u72B6\u6001\u3002\u4F4E\u4E8E\u9608\u503C\uFF0C\u8FDB\u5165\u5173\u95ED\u72B6\u6001</li></ul></li></ul></li></ul><p><img src="`+f+'" alt=""></p><h5 id="\u4EE3\u7801\u5B9E\u73B0-2" tabindex="-1"><a class="header-anchor" href="#\u4EE3\u7801\u5B9E\u73B0-2" aria-hidden="true">#</a> \u4EE3\u7801\u5B9E\u73B0</h5>',7),I={href:"https://github.com/mlabouardy/hystrix-dashboard-docker",target:"_blank",rel:"noopener noreferrer"},F=s("hystrix-go dashboard"),E=a(`<details class="custom-container details"><summary>\u70B9\u51FB\u67E5\u770B\u4EE3\u7801</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;github.com/afex/hystrix-go/hystrix&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_main</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	hystrixStreamHandler <span class="token operator">:=</span> hystrix<span class="token punctuation">.</span><span class="token function">NewStreamHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hystrixStreamHandler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8074&quot;</span><span class="token punctuation">,</span> hystrixStreamHandler<span class="token punctuation">)</span>

	hystrix<span class="token punctuation">.</span><span class="token function">ConfigureCommand</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> hystrix<span class="token punctuation">.</span>CommandConfig<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>                <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// \u5355\u6B21\u8BF7\u6C42 \u8D85\u65F6\u65F6\u95F4</span>
		MaxConcurrentRequests<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// \u6700\u5927\u5E76\u53D1\u91CF</span>
		SleepWindow<span class="token punctuation">:</span>            <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token comment">// \u7194\u65AD\u540E\u591A\u4E45\u53BB\u5C1D\u8BD5\u670D\u52A1\u662F\u5426\u53EF\u7528</span>
		RequestVolumeThreshold<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// \u9A8C\u8BC1\u7194\u65AD\u7684 \u8BF7\u6C42\u6570\u91CF, 10\u79D2\u5185\u91C7\u6837</span>
		ErrorPercentThreshold<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// \u9A8C\u8BC1\u7194\u65AD\u7684 \u9519\u8BEF\u767E\u5206\u6BD4</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//\u5F02\u6B65\u8C03\u7528\u4F7F\u7528 hystrix.Go</span>
		err <span class="token operator">:=</span> hystrix<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token comment">//test case 1 \u5E76\u53D1\u6D4B\u8BD5</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;service error&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//test case 2 \u8D85\u65F6\u6D4B\u8BD5</span>
			<span class="token comment">//time.Sleep(2 * time.Second)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;do services&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hystrix err:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;sleep 1 second&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div></details><h2 id="websocket\u4EE3\u7406" tabindex="-1"><a class="header-anchor" href="#websocket\u4EE3\u7406" aria-hidden="true">#</a> websocket\u4EE3\u7406</h2><h3 id="http1-x\u3001https\u3001http2-x\u534F\u8BAE" tabindex="-1"><a class="header-anchor" href="#http1-x\u3001https\u3001http2-x\u534F\u8BAE" aria-hidden="true">#</a> http1.x\u3001https\u3001http2.x\u534F\u8BAE</h3><h4 id="_1-http\u4E0Ehttps\u7684\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#_1-http\u4E0Ehttps\u7684\u533A\u522B" aria-hidden="true">#</a> 1. http\u4E0Ehttps\u7684\u533A\u522B</h4><ul><li>https \u534F\u8BAE\u9700\u8981 CA \u7533\u8BF7\u8BC1\u4E66(\u6362\u53E5\u6362\u8BF4,\u662F\u8981\u94B1\u7684)</li><li>http \u534F\u8BAE\u8FD0\u884C\u5728 TCP \u534F\u8BAE\u4E4B\u4E0A\uFF0C\u4F20\u8F93\u7684\u5185\u5BB9\u90FD\u662F\u660E\u6587\u4F20\u9001,\u5B89\u5168\u6027\u8F83\u5DEE\u3002\u800C https \u5219\u662F\u8FD0\u884C\u5728 SSL/TLS \u5C42\u4E4B\u4E0A\uFF0C\u800C SSL/TLS \u5C42\u662F\u8FD0\u884C\u5728 TCP \u5C42\u4E4B\u4E0A \uFF0C https \u4F20\u8F93\u7684\u5185\u5BB9\u90FD\u662F\u7ECF\u8FC7\u52A0\u5BC6\u7684\uFF0C\u5B89\u5168\u6027\u8F83\u9AD8</li><li>http \u4E0E https \u4F7F\u7528\u4E0D\u540C\u7684\u8FDE\u63A5\u65B9\u5F0F\uFF0C\u5176\u4E2D http \u9ED8\u8BA4\u7528\u7684\u662F 80 \u7AEF\u53E3\uFF0C\u800C https \u9ED8\u8BA4\u7528\u7684\u662F 443 \u7AEF\u53E3</li></ul><p><img src="`+h+'" alt=""></p><h4 id="_2-http2-0\u548Chttp1-x\u7684\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#_2-http2-0\u548Chttp1-x\u7684\u533A\u522B" aria-hidden="true">#</a> 2. http2.0\u548Chttp1.x\u7684\u533A\u522B:</h4><ul><li><p>http1.x \u662F\u57FA\u4E8E\u6587\u672C\u534F\u8BAE\u7684\u683C\u5F0F\u89E3\u6790\uFF0C \u800C http2.0 \u662F\u57FA\u4E8E\u4E8C\u8FDB\u5236\u534F\u8BAE\u7684\u683C\u5F0F\u89E3\u6790\uFF0C\u66F4\u52A0\u7684\u5F3A\u5927</p></li><li><p>\u591A\u8DEF\u590D\u7528(Mutiplexing) \uFF1A\u4E00\u4E2A\u8FDE\u63A5\u4E0A\u53EF\u4EE5\u6709\u591A\u4E2A request\uFF0C \u4E14\u53EF\u4EE5\u968F\u673A\u7684\u6DF7\u5728\u4E00\u8D77,\u3002\u6BCF\u4E2A\u4E0D\u540C\u7684 request \u90FD\u6709\u5BF9\u5E94\u7684 id\uFF0C\u670D\u52A1\u7AEF\u53EF\u4EE5\u901A\u8FC7 request_id \u6765\u8FA8\u522B\uFF0C\u5927\u5927\u52A0\u5FEB\u4E86\u4F20\u8F93\u901F\u7387</p></li><li><p>header \u538B\u7F29\uFF1Ahttp1.x \u4E2D\u7684 header \u9700\u8981\u643A\u5E26\u5927\u91CF\u4FE1\u606F\uFF0C\u800C\u4E14\u6BCF\u6B21\u90FD\u8981\u91CD\u590D\u53D1\u9001\u3002http2.0 \u4F7F\u7528 encode \u6765\u51CF\u5C11\u4F20\u8F93\u7684 header \u5927\u5C0F\uFF0C\u800C\u4E14\u5BA2\u6237\u7AEF\u548C\u670D\u52A1\u7AEF\u53EF\u4EE5\u5404\u81EA\u7F13\u5B58 (cache) \u4E00\u4EFD header filed \u8868\uFF0C\u907F\u514D\u4E86 header \u7684\u91CD\u590D\u4F20\u8F93\uFF0C\u8FD8\u53EF\u4EE5\u51CF\u5C11\u4F20\u8F93\u7684\u5927\u5C0F\u3002</p></li><li><p>\u670D\u52A1\u7AEF\u63A8\u9001 (server push): \u53EF\u4EE5\u901A\u8FC7\u89E3\u6790 html \u4E2D\u7684\u4F9D\u8D56\uFF0C\u672C\u80FD\u7684\u8FD4\u56DE\u6240\u9700\u7684\u5176\u4ED6\u6587\u4EF6( css \u6216\u8005 js \u7B49)\uFF0C\u800C\u4E0D\u7528\u518D\u53D1\u8D77\u4E00\u6B21\u8BF7\u6C42\u3002</p></li></ul><h5 id="_2-1-\u591A\u8DEF\u590D\u7528\u793A\u610F\u56FE" tabindex="-1"><a class="header-anchor" href="#_2-1-\u591A\u8DEF\u590D\u7528\u793A\u610F\u56FE" aria-hidden="true">#</a> 2.1 \u591A\u8DEF\u590D\u7528\u793A\u610F\u56FE</h5><p><img src="'+q+'" alt=""></p><h5 id="_2-2-\u666E\u901A\u8BF7\u6C42\u793A\u610F\u56FE" tabindex="-1"><a class="header-anchor" href="#_2-2-\u666E\u901A\u8BF7\u6C42\u793A\u610F\u56FE" aria-hidden="true">#</a> 2.2 \u666E\u901A\u8BF7\u6C42\u793A\u610F\u56FE</h5><p><img src="'+y+'" alt=""></p><h5 id="_2-3-\u6D88\u606F\u63A8\u9001\u793A\u610F\u56FE" tabindex="-1"><a class="header-anchor" href="#_2-3-\u6D88\u606F\u63A8\u9001\u793A\u610F\u56FE" aria-hidden="true">#</a> 2.3 \u6D88\u606F\u63A8\u9001\u793A\u610F\u56FE</h5><p><img src="'+w+'" alt=""></p><h2 id="tcp\u4EE3\u7406" tabindex="-1"><a class="header-anchor" href="#tcp\u4EE3\u7406" aria-hidden="true">#</a> tcp\u4EE3\u7406</h2><h2 id="grpc\u4EE3\u7406" tabindex="-1"><a class="header-anchor" href="#grpc\u4EE3\u7406" aria-hidden="true">#</a> grpc\u4EE3\u7406</h2>',16);function Q(M,D){const p=e("ExternalLinkIcon");return o(),c(l,null,[x,n("div",S,[R,P,n("p",null,[n("a",A,[_,t(p)])])]),H,n("ul",null,[C,L,N,W,n("li",null,[n("strong",null,[n("a",T,[B,t(p)])])])]),U,n("ul",null,[n("li",null,[n("strong",null,[n("a",I,[F,t(p)])])])]),E],64)}var z=u(v,[["render",Q]]);export{z as default};
