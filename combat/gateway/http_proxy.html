<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/hero.png"><title>网络代理 | gopherDevOps</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="modulepreload" href="/docs/assets/app.9a368eb2.js"><link rel="modulepreload" href="/docs/assets/http_proxy.html.948f402f.js"><link rel="modulepreload" href="/docs/assets/http_proxy.html.ea15c79c.js"><link rel="modulepreload" href="/docs/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/docs/assets/style.c7b2679d.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/docs/" class=""><img class="logo" src="/docs/images/logo.png" alt="gopherDevOps"><span class="site-name can-hide">gopherDevOps</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="导航"><span class="title">导航</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="导航"><span class="title">导航</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/docs/language/" class="" aria-label="语言"><!--[--><!--]--> 语言 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/tools/linux/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/ops/" class="" aria-label="运维"><!--[--><!--]--> 运维 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/interview/" class="" aria-label="面试"><!--[--><!--]--> 面试 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/design_pattern/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="实战"><span class="title">实战</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="实战"><span class="title">实战</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/docs/combat/gateway/" class="router-link-active" aria-label="微服务网关"><!--[--><!--]--> 微服务网关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/docs/resource/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/docs/command/" class="" aria-label="命令速查"><!--[--><!--]--> 命令速查 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="关于"><span class="title">关于</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="关于"><span class="title">关于</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/jiaruling" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://hub.docker.com/" rel="noopener noreferrer" target="_blank" aria-label="Docker Hub"><!--[--><!--]--> Docker Hub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="导航"><span class="title">导航</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="导航"><span class="title">导航</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/docs/language/" class="" aria-label="语言"><!--[--><!--]--> 语言 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/tools/linux/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/ops/" class="" aria-label="运维"><!--[--><!--]--> 运维 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/interview/" class="" aria-label="面试"><!--[--><!--]--> 面试 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/docs/design_pattern/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="实战"><span class="title">实战</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="实战"><span class="title">实战</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/docs/combat/gateway/" class="router-link-active" aria-label="微服务网关"><!--[--><!--]--> 微服务网关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/docs/resource/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/docs/command/" class="" aria-label="命令速查"><!--[--><!--]--> 命令速查 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="关于"><span class="title">关于</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="关于"><span class="title">关于</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/jiaruling" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://hub.docker.com/" rel="noopener noreferrer" target="_blank" aria-label="Docker Hub"><!--[--><!--]--> Docker Hub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">微服务网关 <span class="down arrow"></span></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/docs/combat/gateway/" class="router-link-active sidebar-item" aria-label="Go 实现微服务网关"><!--[--><!--]--> Go 实现微服务网关 <!--[--><!--]--></a><!----></li><li><a href="/docs/combat/gateway/net.html" class="sidebar-item" aria-label="PreStudy"><!--[--><!--]--> PreStudy <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="网络代理"><!--[--><!--]--> 网络代理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#什么是网络代理" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是网络代理"><!--[--><!--]--> 什么是网络代理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#网络代理与网络转发的区别" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络代理与网络转发的区别"><!--[--><!--]--> 网络代理与网络转发的区别 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#网络代理类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络代理类型"><!--[--><!--]--> 网络代理类型 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#http代理" class="router-link-active router-link-exact-active sidebar-item" aria-label="http代理"><!--[--><!--]--> http代理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#需要实现的基本功能" class="router-link-active router-link-exact-active sidebar-item" aria-label="需要实现的基本功能"><!--[--><!--]--> 需要实现的基本功能 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#reverseproxy-标准库" class="router-link-active router-link-exact-active sidebar-item" aria-label="ReverseProxy -- 标准库"><!--[--><!--]--> ReverseProxy -- 标准库 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#四种负载均衡策略" class="router-link-active router-link-exact-active sidebar-item" aria-label="四种负载均衡策略"><!--[--><!--]--> 四种负载均衡策略 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#中间件" class="router-link-active router-link-exact-active sidebar-item" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#限流、熔断、降级" class="router-link-active router-link-exact-active sidebar-item" aria-label="限流、熔断、降级"><!--[--><!--]--> 限流、熔断、降级 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#websocket代理" class="router-link-active router-link-exact-active sidebar-item" aria-label="websocket代理"><!--[--><!--]--> websocket代理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#http1-x、https、http2-x协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="http1.x、https、http2.x协议"><!--[--><!--]--> http1.x、https、http2.x协议 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#tcp代理" class="router-link-active router-link-exact-active sidebar-item" aria-label="tcp代理"><!--[--><!--]--> tcp代理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/combat/gateway/http_proxy.html#grpc代理" class="router-link-active router-link-exact-active sidebar-item" aria-label="grpc代理"><!--[--><!--]--> grpc代理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="什么是网络代理" tabindex="-1"><a class="header-anchor" href="#什么是网络代理" aria-hidden="true">#</a> 什么是网络代理</h2><ul><li>用户通过代理请求信息</li><li>请求通过网络代理完成转发到达目标服务器</li><li>目标服务器响应后再通过网络代理回传给用户</li></ul><h3 id="网络代理与网络转发的区别" tabindex="-1"><a class="header-anchor" href="#网络代理与网络转发的区别" aria-hidden="true">#</a> 网络代理与网络转发的区别</h3><ul><li><strong>网络代理:</strong> 用户不直接连接服务器，网络代理去连接，获取数据后返回给用户。</li></ul><p><img src="/docs/images/daili.png" alt=""></p><ul><li><strong>网络转发</strong>: 是路由器对报文的转发操作，中间可能对数据包修改。</li></ul><p><img src="/docs/images/zhuanfa.png" alt=""></p><h3 id="网络代理类型" tabindex="-1"><a class="header-anchor" href="#网络代理类型" aria-hidden="true">#</a> 网络代理类型</h3><ul><li><strong>正向代理：<strong>是一种</strong>客户端的代理</strong>技术，帮助客户端访问无法访问的服务资源，可以隐藏用户真实IP。比如：浏览器web代理，VPN等。 <ul><li>代理接收客户端请求，复制原请求对象，并根据数据配置新请求的各种参数</li><li>把新请求发送到真实服务端，并接收服务器端返回</li><li>代理服务器对相应做一些处理，然后返回给客户端</li></ul></li></ul><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 目前在Windows11 上没有测试成功</span>
<span class="token comment">// 需要关闭防火墙</span>
<span class="token comment">// 只能访问http的服务，不能访问https的服务</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Pxy <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pxy<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received request %s %s %s\n&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
	transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultTransport
	<span class="token comment">// step 1，浅拷贝对象，然后就再新增属性数据</span>
	outReq <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
	<span class="token operator">*</span>outReq <span class="token operator">=</span> <span class="token operator">*</span>req
	<span class="token keyword">if</span> clientIP<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> prior<span class="token punctuation">,</span> ok <span class="token operator">:=</span> outReq<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			clientIP <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>prior<span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> clientIP
		<span class="token punctuation">}</span>
		outReq<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// step 2, 请求下游</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> transport<span class="token punctuation">.</span><span class="token function">RoundTrip</span><span class="token punctuation">(</span>outReq<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		rw<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadGateway<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// step 3, 把下游请求内容返回给上游</span>
	<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> res<span class="token punctuation">.</span>Header <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> value <span class="token punctuation">{</span>
			rw<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	rw<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Serve on :8080&quot;</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Pxy<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0:8080&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div></details><ul><li><strong>反向代理：<strong>是一种</strong>服务端的代理</strong>技术，帮助服务器做负载均衡、缓存、提供安全校验等，可以隐藏服务器真实IP。比如：LVS技术、nginx、proxy_pass等 <ul><li>代理接收客户端请求，更改请求结构体信息</li><li>通过一定的负载均衡算法获取下游服务地址</li><li>把请求发送到下游服务器，并获取返回内容</li><li>对返回内容做一些处理，然后返回给客户端</li></ul></li></ul><p><img src="/docs/images/proxy_server.png" alt=""></p><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 下游服务</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//监听关闭信号</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 反向代理服务</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	proxy_addr <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:2003&quot;</span>
	port       <span class="token operator">=</span> <span class="token string">&quot;2002&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//step 1 解析代理地址，并更改请求体的协议和主机</span>
	proxy<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> proxy<span class="token punctuation">.</span>Scheme <span class="token comment">// http</span>
	r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> proxy<span class="token punctuation">.</span>Host <span class="token comment">// 127.0.0.1:2003</span>

	<span class="token comment">//step 2 请求下游</span>
	transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultTransport
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> transport<span class="token punctuation">.</span><span class="token function">RoundTrip</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//step 3 把下游请求内容返回给上游</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> vv <span class="token operator">:=</span> <span class="token keyword">range</span> resp<span class="token punctuation">.</span>Header <span class="token punctuation">{</span> <span class="token comment">// 请求头</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> vv <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteTo</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token comment">// 请求体</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Start serving on port &quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>port<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div></details><h2 id="http代理" tabindex="-1"><a class="header-anchor" href="#http代理" aria-hidden="true">#</a> http代理</h2><h3 id="需要实现的基本功能" tabindex="-1"><a class="header-anchor" href="#需要实现的基本功能" aria-hidden="true">#</a> 需要实现的基本功能</h3><ul><li>错误回调及错误日志处理</li><li>更改下游服务返回内容</li><li>负载均衡</li><li>url重写</li><li>限流、熔断、降级</li><li>数据统计</li><li>权限验证</li></ul><h3 id="reverseproxy-标准库" tabindex="-1"><a class="header-anchor" href="#reverseproxy-标准库" aria-hidden="true">#</a> ReverseProxy -- 标准库</h3><h4 id="功能点" tabindex="-1"><a class="header-anchor" href="#功能点" aria-hidden="true">#</a> 功能点</h4><ul><li>更改内容支持</li><li>错误信息回调</li><li>支持自定义负载均衡</li><li>url重写功能</li><li>连接池功能</li><li>支持websocket服务</li><li>支持https代理</li></ul><h4 id="reverseproxy-代理的下游服务" tabindex="-1"><a class="header-anchor" href="#reverseproxy-代理的下游服务" aria-hidden="true">#</a> ReverseProxy 代理的下游服务</h4><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//监听关闭信号</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div></details><h4 id="reverseproxy-简单使用" tabindex="-1"><a class="header-anchor" href="#reverseproxy-简单使用" aria-hidden="true">#</a> ReverseProxy 简单使用</h4><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:2002/xxx --&gt; 127.0.0.1:2003/base/xxx</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> httputil<span class="token punctuation">.</span><span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></details><h4 id="reverseproxy-修改返回内容" tabindex="-1"><a class="header-anchor" href="#reverseproxy-修改返回内容" aria-hidden="true">#</a> ReverseProxy 修改返回内容</h4><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:2002/xxx</span>
	<span class="token comment">//127.0.0.1:2003/base/xxx</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003/base&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>target <span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//http://127.0.0.1:2002/dir?name=123</span>
	<span class="token comment">//RayQuery: name=123</span>
	<span class="token comment">//Scheme: http</span>
	<span class="token comment">//Host: 127.0.0.1:2002</span>
	targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>

		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">//target.Path : /base</span>
		<span class="token comment">//req.URL.Path : /dir</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>res <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			<span class="token comment">//return errors.New(&quot;error statusCode&quot;)</span>
            <span class="token comment">// 获取下游服务的响应内容</span>
			oldPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
            <span class="token comment">// 修改下游服务的响应内容</span>
			newPayLoad <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;hello &quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>oldPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 回写响应体内容</span>
			res<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 重置响应体长度</span>
			res<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span>
			res<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayLoad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	errorHandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>res http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>Director<span class="token punctuation">:</span> director<span class="token punctuation">,</span> ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">:</span> errorHandler<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div></details><h4 id="reverseproxy-特殊请求头-connection" tabindex="-1"><a class="header-anchor" href="#reverseproxy-特殊请求头-connection" aria-hidden="true">#</a> ReverseProxy 特殊请求头 -- Connection</h4><ul><li>标记<strong>请求发送方</strong>与<strong>第一代理</strong>的状态</li><li>决定当前事务完成后，是否会关闭网络 <ul><li>Connection：keep-alive //不关闭网络</li><li>Connection：close //关闭网络</li><li>Connection：Upgrade //协议升级</li></ul></li></ul><p><img src="/docs/images/mproxy.png" alt=""></p><h4 id="reverseproxy-特殊请求响应头-te、trailer" tabindex="-1"><a class="header-anchor" href="#reverseproxy-特殊请求响应头-te、trailer" aria-hidden="true">#</a> ReverseProxy 特殊请求响应头 -- TE、Trailer</h4><ul><li>TE <ul><li>请求头</li><li>表示希望使用的传输编码类型</li><li>如：TE: trailers, deflate;q=0.5，表示期望在采用分块传输编码响应中接收挂载字段, zlib编码, 0.5优先级排序</li></ul></li><li>Trailer <ul><li>响应头</li><li>允许发送方在消息后面添加额外的元信息</li><li>如：Trailer: Expires, 表示Expires 将出现在分块信息的结尾</li></ul></li></ul><h4 id="第一代理去除标准的逐段传输头" tabindex="-1"><a class="header-anchor" href="#第一代理去除标准的逐段传输头" aria-hidden="true">#</a> 第一代理去除标准的逐段传输头</h4><ul><li>逐段传输头都需要在 Connection 头中列出</li><li>第一代理知道必须处理它们（如协议升级），并且不转发它。</li><li>逐段传输头 <ul><li>Keep-Alive</li><li>Transfer-Encoding</li><li>TE</li><li>Connection</li><li>Trailer</li><li>Upgrade</li><li>Proxy-Authorization</li><li>Proxy-Authenticate</li></ul></li></ul><h4 id="特殊statuscode" tabindex="-1"><a class="header-anchor" href="#特殊statuscode" aria-hidden="true">#</a> 特殊StatusCode</h4><ul><li><strong>100:</strong> 表示目前一切正常，客户端可以继续请求 <ul><li>客户端要POST的数据大于1024字节的时候</li><li>客户端不会直接就发起POST请求，而是分为两步 <ul><li>发送一个请求，包含一个Expect: 100-continue,询问Server是否愿意接收数据</li><li>接收到Server返回的100-continue应答以后，返回100状态，才把数据POST给Server</li></ul></li></ul></li><li><strong>101:</strong> 服务端发送给客户端升级协议的请求</li></ul><p><img src="/docs/images/statusCode101.png" alt=""></p><h4 id="请求头-x-forward-for-和-x-real-ip" tabindex="-1"><a class="header-anchor" href="#请求头-x-forward-for-和-x-real-ip" aria-hidden="true">#</a> 请求头 X-Forward-For 和 X-Real-Ip</h4><ul><li>X-Forwarded-For <ul><li>记录最后直连实际服务器之前的整个代理过程</li><li>可能会被伪造</li></ul></li></ul><p><img src="/docs/images/x-forward-for.png" alt=""></p><ul><li>X-Real-IP <ul><li>请求实际服务器的IP</li><li>每过一层代理都会被覆盖掉，只需第一代理设置转发</li><li>不会被位置</li></ul></li></ul><p><img src="/docs/images/x-real-ip.png" alt=""></p><h5 id="代码实现" tabindex="-1"><a class="header-anchor" href="#代码实现" aria-hidden="true">#</a> 代码实现</h5><details class="custom-container details"><summary>点击查看代码</summary><ul><li>真实服务</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// real_server/main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;os/signal&quot;</span>
	<span class="token string">&quot;syscall&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">}</span>
	rs1<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rs2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RealServer<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">}</span>
	rs2<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//监听关闭信号</span>
	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>HelloHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/base/error&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ErrorHandler<span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/test_http_string/test_http_string/aaa&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>TimeoutHandler<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
		WriteTimeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span>      mux<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">HelloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//127.0.0.1:8008/abc?sdsdsa=11</span>
	<span class="token comment">//r.Addr=127.0.0.1:8008</span>
	<span class="token comment">//req.URL.Path=/abc</span>
	<span class="token comment">//fmt.Println(req.Host)</span>
	upath <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s%s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
	realIP <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;RemoteAddr=%s,X-Forwarded-For=%v,X-Real-Ip=%v\n&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Real-Ip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	header<span class="token operator">:=</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;headers =%v\n&quot;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> realIP<span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> header<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;error handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RealServer<span class="token punctuation">)</span> <span class="token function">TimeoutHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	upath <span class="token operator">:=</span> <span class="token string">&quot;timeout handler&quot;</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> upath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><ul><li>第二层代理</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// reverse_proxy/main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;compress/gzip&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//rs1 := &quot;http://www.baidu.com&quot;</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2003&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//rs2 := &quot;http://www.baidu.com&quot;</span>
	rs2 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2004&quot;</span>
	url2<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs2<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>url1<span class="token punctuation">,</span> url2<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> transport <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
	DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//连接超时</span>
		KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//长连接超时时间</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
	MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">//最大空闲连接</span>
	IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//空闲超时时间</span>
	TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//tls握手超时时间</span>
	ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//100-continue 超时时间</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>targets <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//请求协调者</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//随机负载均衡</span>
		targetIndex <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span>
		target <span class="token operator">:=</span> targets<span class="token punctuation">[</span>targetIndex<span class="token punctuation">]</span>
		targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">//todo 部分章节补充1</span>
		<span class="token comment">//todo 当对域名(非内网)反向代理时需要设置此项。当作后端反向代理时不需要</span>
		req<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">// url地址重写：重写前：/aa 重写后：/base/aa</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//只在第一代理中设置此header头</span>
		<span class="token comment">//req.Header.Set(&quot;X-Real-Ip&quot;, req.RemoteAddr)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//更改内容</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">//请求以下命令：curl &#39;http://127.0.0.1:2002/error&#39;</span>
		<span class="token comment">//todo 部分章节功能补充2</span>
		<span class="token comment">//todo 兼容websocket</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Upgrade&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">var</span> payload <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		<span class="token keyword">var</span> readErr <span class="token builtin">error</span>

		<span class="token comment">//todo 部分章节功能补充3</span>
		<span class="token comment">//todo 兼容gzip压缩</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			gr<span class="token punctuation">,</span> err <span class="token operator">:=</span> gzip<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			payload<span class="token punctuation">,</span> readErr <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>gr<span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Encoding&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			payload<span class="token punctuation">,</span> readErr <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> readErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> readErr
		<span class="token punctuation">}</span>

		<span class="token comment">//异常请求时设置StatusCode</span>
		<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;StatusCode error:&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//todo 部分章节功能补充4</span>
		<span class="token comment">//todo 因为预读了数据所以内容重新回写</span>
		resp<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//错误回调 ：关闭real_server时测试，错误回调</span>
	errFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;ErrorHandler error:&quot;</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>
		Director<span class="token punctuation">:</span>       director<span class="token punctuation">,</span>
		Transport<span class="token punctuation">:</span>      transport<span class="token punctuation">,</span>
		ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span>
		ErrorHandler<span class="token punctuation">:</span>   errFunc<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><ul><li>第一层代理</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// reverse_proxy_level1/main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httputil&quot;</span>
	<span class="token string">&quot;net/url&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:2001&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rs1 <span class="token operator">:=</span> <span class="token string">&quot;http://127.0.0.1:2002&quot;</span>
	url1<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rs1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>url1<span class="token punctuation">}</span>
	proxy <span class="token operator">:=</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting httpserver at &quot;</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> transport <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>
	DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//连接超时</span>
		KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//长连接超时时间</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
	MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">//最大空闲连接</span>
	IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//空闲超时时间</span>
	TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">//tls握手超时时间</span>
	ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">//100-continue 超时时间</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMultipleHostsReverseProxy</span><span class="token punctuation">(</span>targets <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
	<span class="token comment">//请求协调者</span>
	director <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//url_rewrite</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2003/base/abc ??</span>
		<span class="token comment">//127.0.0.1:2002/dir/abc ==&gt; 127.0.0.1:2002/abc</span>
		<span class="token comment">//127.0.0.1:2002/abc ==&gt; 127.0.0.1:2003/base/abc</span>
		re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token string">&quot;^/dir(.*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//随机负载均衡</span>
		targetIndex <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span>
		target <span class="token operator">:=</span> targets<span class="token punctuation">[</span>targetIndex<span class="token punctuation">]</span>
		targetQuery <span class="token operator">:=</span> target<span class="token punctuation">.</span>RawQuery
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host

		<span class="token comment">// url地址重写：重写前：/aa 重写后：/base/aa</span>
		req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> targetQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> targetQuery <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user-agent&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//只在第一代理中设置此header头</span>
		req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;X-Real-Ip&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//更改内容</span>
	modifyFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">//请求以下命令：curl &#39;http://127.0.0.1:2002/error&#39;</span>
		<span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
			<span class="token comment">//获取内容</span>
			oldPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token comment">//追加内容</span>
			newPayload <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;StatusCode error:&quot;</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>oldPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
			resp<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>newPayload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//错误回调 ：关闭real_server时测试，错误回调</span>
	errFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;ErrorHandler error:&quot;</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>httputil<span class="token punctuation">.</span>ReverseProxy<span class="token punctuation">{</span>
		Director<span class="token punctuation">:</span>       director<span class="token punctuation">,</span>
		Transport<span class="token punctuation">:</span>      transport<span class="token punctuation">,</span>
		ModifyResponse<span class="token punctuation">:</span> modifyFunc<span class="token punctuation">,</span>
		ErrorHandler<span class="token punctuation">:</span>   errFunc<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">singleJoiningSlash</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	aslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	bslash <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> aslash <span class="token operator">&amp;&amp;</span> bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>aslash <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bslash<span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><ul><li>运行结果</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token string">&#39;http://127.0.0.1:2001/base&#39;</span>
http://127.0.0.1:2004/base
<span class="token assign-left variable">RemoteAddr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:55561,X-Forwarded-For<span class="token operator">=</span><span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1,X-Real-Ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1:55557
headers <span class="token operator">=</span>map<span class="token punctuation">[</span>Accept:<span class="token punctuation">[</span>text/html,application/xhtml+xml,application/xml<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,image/webp,image/apng,*/*<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,application/signed-exchange<span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span>b3<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">]</span> Accept-Encoding:<span class="token punctuation">[</span>gzip, deflate, br<span class="token punctuation">]</span> Accept-Language:<span class="token punctuation">[</span>zh-CN,zh<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,en<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,en-GB<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.7</span>,en-US<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">]</span> Sec-Ch-Ua:<span class="token punctuation">[</span><span class="token string">&quot; Not A;Brand&quot;</span><span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token string">&quot;99&quot;</span>, <span class="token string">&quot;Chromium&quot;</span><span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token string">&quot;99&quot;</span>, <span class="token string">&quot;Microsoft Edge&quot;</span><span class="token punctuation">;</span><span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token string">&quot;99&quot;</span><span class="token punctuation">]</span> Sec-Ch-Ua-Mobile:<span class="token punctuation">[</span>?0<span class="token punctuation">]</span> Sec-Ch-Ua-Platform:<span class="token punctuation">[</span><span class="token string">&quot;Windows&quot;</span><span class="token punctuation">]</span> Sec-Fetch-Dest:<span class="token punctuation">[</span>document<span class="token punctuation">]</span> Sec-Fetch-Mode:<span class="token punctuation">[</span>navigate<span class="token punctuation">]</span> Sec-Fetch-Site:<span class="token punctuation">[</span>none<span class="token punctuation">]</span> Sec-Fetch-User:<span class="token punctuation">[</span>?1<span class="token punctuation">]</span> Upgrade-Insecure-Requests:<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> User-Agent:<span class="token punctuation">[</span>Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/99.0.4844.74 Safari/537.36 Edg/99.0.1150.46<span class="token punctuation">]</span> X-Forwarded-For:<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1<span class="token punctuation">]</span> X-Real-Ip:<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1:55557<span class="token punctuation">]</span><span class="token punctuation">]</span>
$ <span class="token function">curl</span> -H <span class="token string">&#39;X-Forwarded-For: 2.2.2.2&#39;</span> <span class="token string">&#39;http://127.0.0.1:2001/base&#39;</span>
http://127.0.0.1:2004/base
<span class="token assign-left variable">RemoteAddr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:55886,X-Forwarded-For<span class="token operator">=</span><span class="token number">2.2</span>.2.2, <span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1,X-Real-Ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1:55596
headers <span class="token operator">=</span>map<span class="token punctuation">[</span>Accept:<span class="token punctuation">[</span>*/*<span class="token punctuation">]</span> Accept-Encoding:<span class="token punctuation">[</span>gzip, deflate, br<span class="token punctuation">]</span> Content-Length:<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span> Content-Type:<span class="token punctuation">[</span>application/json<span class="token punctuation">]</span> Postman-Token:<span class="token punctuation">[</span>3043f404-069c-4c62-97a8-c18da86e2a84<span class="token punctuation">]</span> User-Agent:<span class="token punctuation">[</span>PostmanRuntime/7.28.4<span class="token punctuation">]</span> X-Forwarded-For:<span class="token punctuation">[</span><span class="token number">2.2</span>.2.2, <span class="token number">127.0</span>.0.1, <span class="token number">127.0</span>.0.1<span class="token punctuation">]</span> X-Real-Ip:<span class="token punctuation">[</span><span class="token number">127.0</span>.0.1:55596<span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></details><h3 id="四种负载均衡策略" tabindex="-1"><a class="header-anchor" href="#四种负载均衡策略" aria-hidden="true">#</a> 四种负载均衡策略</h3><ul><li><strong>随机负载:</strong> 随机挑选目标服务器IP</li><li><strong>轮询负载:</strong> ABC三台服务器，ABCABC依次轮询</li><li><strong>加权负载:</strong> 给目标设置访问权重，按照权重轮询</li><li><strong>一致性hash负载:</strong> 请求固定URL访问指定IP</li></ul><h4 id="随机策略" tabindex="-1"><a class="header-anchor" href="#随机策略" aria-hidden="true">#</a> 随机策略</h4><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> RandomBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RandomBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>r<span class="token punctuation">.</span>curIndex<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestRandomBalance</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>RandomBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><ul><li>运行结果</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run TestRandomBalance
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2004
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.035s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></details><h4 id="轮询策略" tabindex="-1"><a class="header-anchor" href="#轮询策略" aria-hidden="true">#</a> 轮询策略</h4><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> RoundRobinBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	lens <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span> <span class="token comment">//5</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>curIndex <span class="token operator">&gt;=</span> lens <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	curAddr <span class="token operator">:=</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>r<span class="token punctuation">.</span>curIndex<span class="token punctuation">]</span>
	r<span class="token punctuation">.</span>curIndex <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> lens
	<span class="token keyword">return</span> curAddr
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Test_main</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>RoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><ul><li>运行结果</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run Test_main
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2006
<span class="token number">127.0</span>.0.1:2007
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2006
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.039s

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details><h4 id="加权轮询策略" tabindex="-1"><a class="header-anchor" href="#加权轮询策略" aria-hidden="true">#</a> 加权轮询策略</h4><div class="custom-container tip"><p class="custom-container-title">实现原理</p><p><strong>ServerA=4 | ServerB=3 | ServerC=2</strong></p></div><table><thead><tr><th>请求次数</th><th>请求前currentWeight</th><th>选中的节点</th><th>请求后currentWeight</th></tr></thead><tbody><tr><td>1</td><td>[ServerA=4, ServerB=3, ServerC=2]</td><td>ServerA</td><td>[ServerA=-1, ServerB=6, ServerC=4]</td></tr><tr><td>2</td><td>[ServerA=-1, ServerB=6, ServerC=4]</td><td>ServerB</td><td>[ServerA=3, ServerB=0, ServerC=6]</td></tr><tr><td>3</td><td>[ServerA=3, ServerB=0, ServerC=6]</td><td>ServerC</td><td>[ServerA=7, ServerB=3, ServerC=-1]</td></tr><tr><td>4</td><td>[ServerA=7, ServerB=3, ServerC=-1]</td><td>ServerA</td><td>[ServerA=2, ServerB=6, ServerC=1]</td></tr><tr><td>5</td><td>[ServerA=2, ServerB=6, ServerC=1]</td><td>ServerB</td><td>[ServerA=6, ServerB=0, ServerC=3]</td></tr><tr><td>6</td><td>[ServerA=6, ServerB=0, ServerC=3]</td><td>ServerA</td><td>[ServerA=1, ServerB=3, ServerC=5]</td></tr><tr><td>7</td><td>[ServerA=1, ServerB=3, ServerC=5]</td><td>ServerC</td><td>[ServerA=5, ServerB=6, ServerC=-2]</td></tr><tr><td>8</td><td>[ServerA=5, ServerB=6, ServerC=-2]</td><td>ServerB</td><td>[ServerA=9, ServerB=0, ServerC=0]</td></tr><tr><td>9</td><td>[ServerA=9, ServerB=0, ServerC=0]</td><td>ServerA</td><td>[ServerA=4, ServerB=3, ServerC=2]</td></tr></tbody></table><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> WeightRoundRobinBalance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	curIndex <span class="token builtin">int</span>
	rss      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>WeightNode
	rsw      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> WeightNode <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	addr            <span class="token builtin">string</span>
	weight          <span class="token builtin">int</span> <span class="token comment">//权重值</span>
	currentWeight   <span class="token builtin">int</span> <span class="token comment">//节点当前权重</span>
	effectiveWeight <span class="token builtin">int</span> <span class="token comment">//有效权重</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>WeightRoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len need 2&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	parInt<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	node <span class="token operator">:=</span> <span class="token operator">&amp;</span>WeightNode<span class="token punctuation">{</span>addr<span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token function">int</span><span class="token punctuation">(</span>parInt<span class="token punctuation">)</span><span class="token punctuation">}</span>
	node<span class="token punctuation">.</span>effectiveWeight <span class="token operator">=</span> node<span class="token punctuation">.</span>weight
	r<span class="token punctuation">.</span>rss <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>WeightRoundRobinBalance<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	total <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">var</span> best <span class="token operator">*</span>WeightNode
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>rss<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		w <span class="token operator">:=</span> r<span class="token punctuation">.</span>rss<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token comment">//step 1 统计所有有效权重之和</span>
		total <span class="token operator">+=</span> w<span class="token punctuation">.</span>effectiveWeight

		<span class="token comment">//step 2 变更节点临时权重为的节点临时权重+节点有效权重</span>
		w<span class="token punctuation">.</span>currentWeight <span class="token operator">+=</span> w<span class="token punctuation">.</span>effectiveWeight

		<span class="token comment">//step 3 有效权重默认与权重相同，通讯异常时-1, 通讯成功+1，直到恢复到weight大小</span>
		<span class="token keyword">if</span> w<span class="token punctuation">.</span>effectiveWeight <span class="token operator">&lt;</span> w<span class="token punctuation">.</span>weight <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span>effectiveWeight<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//step 4 选择最大临时权重点节点</span>
		<span class="token keyword">if</span> best <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>currentWeight <span class="token operator">&gt;</span> best<span class="token punctuation">.</span>currentWeight <span class="token punctuation">{</span>
			best <span class="token operator">=</span> w
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> best <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//step 5 变更临时权重为 临时权重-有效权重之和</span>
	best<span class="token punctuation">.</span>currentWeight <span class="token operator">-=</span> total
	<span class="token keyword">return</span> best<span class="token punctuation">.</span>addr
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">TestLB</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token operator">&amp;</span>WeightRoundRobinBalance<span class="token punctuation">{</span><span class="token punctuation">}</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><ul><li>运行结果</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run TestLB
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
<span class="token number">127.0</span>.0.1:2005
<span class="token number">127.0</span>.0.1:2003
<span class="token number">127.0</span>.0.1:2004
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.039s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></details><h4 id="一致性哈希策略" tabindex="-1"><a class="header-anchor" href="#一致性哈希策略" aria-hidden="true">#</a> 一致性哈希策略</h4><div class="custom-container tip"><p class="custom-container-title">一致性哈希指标</p><p>单调性 、 平衡性、分散性、负载、平滑性</p><p><a href="https://zhuanlan.zhihu.com/p/146011745" target="_blank" rel="noopener noreferrer">一致性hash环原理<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> load_balance

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;hash/crc32&quot;</span>
	<span class="token string">&quot;sort&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Hash <span class="token keyword">func</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span>

<span class="token keyword">type</span> UInt32Slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s UInt32Slice<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConsistentHashBanlance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mux      sync<span class="token punctuation">.</span>RWMutex
	hash     Hash
	replicas <span class="token builtin">int</span>               <span class="token comment">//复制因子</span>
	keys     UInt32Slice       <span class="token comment">//已排序的节点hash切片</span>
	hashMap  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint32</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//节点哈希和Key的map,键是hash值，值是节点key</span>

	<span class="token comment">//观察主体</span>
	conf LoadBalanceConf
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span>replicas <span class="token builtin">int</span><span class="token punctuation">,</span> fn Hash<span class="token punctuation">)</span> <span class="token operator">*</span>ConsistentHashBanlance <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConsistentHashBanlance<span class="token punctuation">{</span>
		replicas<span class="token punctuation">:</span> replicas<span class="token punctuation">,</span>
		hash<span class="token punctuation">:</span>     fn<span class="token punctuation">,</span>
		hashMap<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint32</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>hash <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">//最多32位,保证是一个2^32-1环</span>
		m<span class="token punctuation">.</span>hash <span class="token operator">=</span> crc32<span class="token punctuation">.</span>ChecksumIEEE
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> m
<span class="token punctuation">}</span>

<span class="token comment">// 验证是否为空</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add 方法用来添加缓存节点，参数为节点key，比如使用IP</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>params <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;param len 1 at least&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 结合复制因子计算所有虚拟节点的hash值，并存入m.keys中，同时在m.hashMap中保存哈希值和key的映射</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>replicas<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		hash <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>hashMap<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> addr
	<span class="token punctuation">}</span>
	<span class="token comment">// 对所有虚拟节点的哈希值进行排序，方便之后进行二分查找</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get 方法根据给定的对象获取最靠近它的那个节点</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConsistentHashBanlance<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;node is empty&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	hash <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 通过二分查找获取最优节点，第一个&quot;服务器hash&quot;值大于&quot;数据hash&quot;值的就是最优&quot;服务器节点&quot;</span>
	idx <span class="token operator">:=</span> sort<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> c<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> hash <span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// 如果查找结果 大于 服务器节点哈希数组的最大索引，表示此时该对象哈希值位于最后一个节点之后，那么放入第一个节点中</span>
	<span class="token keyword">if</span> idx <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		idx <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>hashMap<span class="token punctuation">[</span>c<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestNewConsistentHashBanlance</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rb <span class="token operator">:=</span> <span class="token function">NewConsistentHashBanlance</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2003&quot;</span><span class="token punctuation">)</span> <span class="token comment">//0</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2004&quot;</span><span class="token punctuation">)</span> <span class="token comment">//1</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2005&quot;</span><span class="token punctuation">)</span> <span class="token comment">//2</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2006&quot;</span><span class="token punctuation">)</span> <span class="token comment">//3</span>
	rb<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2007&quot;</span><span class="token punctuation">)</span> <span class="token comment">//4</span>

	<span class="token comment">//url hash</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/getinfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/getinfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:2002/base/changepwd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">//ip hash</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><ul><li>运行结果</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run TestNewConsistentHashBanlance
<span class="token number">127.0</span>.0.1:2004 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2005 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2004 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2005 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2007 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2003 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
<span class="token number">127.0</span>.0.1:2007 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span>
PASS
ok      github.com/e421083458/gateway_demo/proxy/load_balance   <span class="token number">0</span>.039s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></details><h3 id="中间件" tabindex="-1"><a class="header-anchor" href="#中间件" aria-hidden="true">#</a> 中间件</h3><h3 id="限流、熔断、降级" tabindex="-1"><a class="header-anchor" href="#限流、熔断、降级" aria-hidden="true">#</a> 限流、熔断、降级</h3><h4 id="限流器-time-rate" tabindex="-1"><a class="header-anchor" href="#限流器-time-rate" aria-hidden="true">#</a> 限流器 time/rate</h4><h5 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h5><ul><li>限流器是后台服务中的非常重要的组件，可以用来限制请求速率，保护服务，以免服务过载。</li><li>限流器的实现方法有很多种，例如滑动窗口法、Token Bucket、Leaky Bucket 等。</li><li>其实 Golang 标准库中就自带了限流算法的实现，即 <code>golang.org/x/time/rate</code>。该限流器是基于 <strong>Token Bucket(令牌桶)</strong> 实现的。</li><li>简单来说，令牌桶就是想象有一个固定大小的桶，系统会以恒定速率向桶中放 Token，桶满则暂时不放。而用户则从桶中取 Token，如果有剩余 Token 就可以一直取。如果没有剩余 Token，则需要等到系统中被放置了 Token 才行。</li><li><strong><a href="https://www.cyhone.com/articles/usage-of-golang-rate/" target="_blank" rel="noopener noreferrer">API使用说明<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></li></ul><h5 id="代码实现-1" tabindex="-1"><a class="header-anchor" href="#代码实现-1" aria-hidden="true">#</a> 代码实现</h5><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;golang.org/x/time/rate&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRateLimiter</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l <span class="token operator">:=</span> rate<span class="token punctuation">.</span><span class="token function">NewLimiter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;limit: %f, burst: %d&quot;</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">Burst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//阻塞等待直到，取到一个token</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;before Wait&quot;</span><span class="token punctuation">)</span>
		c<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;limiter wait err:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;after Wait&quot;</span><span class="token punctuation">)</span>

		<span class="token comment">//返回需要等待多久才有新的token,这样就可以等待指定时间执行任务</span>
		r <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Reserve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;reserve Delay:&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">//判断当前是否可以取到token</span>
		a <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Allow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Allow:&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------------------------------------------------------------------------------&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> -test.run Test_RateLimiter
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 limit: <span class="token number">1.000000</span>, burst: <span class="token number">5</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 reserve Delay: 0s
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 Allow: <span class="token boolean">true</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 reserve Delay: 0s
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:44 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 reserve Delay: <span class="token number">990</span>.1707ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:45 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 reserve Delay: <span class="token number">987</span>.1507ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:47 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 reserve Delay: <span class="token number">994</span>.5779ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:49 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 reserve Delay: <span class="token number">993</span>.5709ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:51 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 reserve Delay: <span class="token number">992</span>.4085ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:53 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 reserve Delay: <span class="token number">993</span>.1072ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:55 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 reserve Delay: <span class="token number">994</span>.7224ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 -----------------------------------------------------------------------------------------------
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:57 before Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 after Wait
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 reserve Delay: <span class="token number">985</span>.14ms
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 Allow: <span class="token boolean">false</span>
<span class="token number">2022</span>/03/22 <span class="token number">17</span>:47:59 -----------------------------------------------------------------------------------------------
PASS
ok      github.com/e421083458/gateway_demo/demo/proxy/rate_limiter      <span class="token number">15</span>.357s
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><ul><li>初始化限流器的时候，桶中有5个token，所以前5次取的时候就直接通过，当桶中的token取完以后，每秒只产生一个token，所以每间隔一秒只有一个能成功取到token</li></ul></details><h4 id="熔断器-hystrix-go" tabindex="-1"><a class="header-anchor" href="#熔断器-hystrix-go" aria-hidden="true">#</a> 熔断器 hystrix-go</h4><h5 id="介绍-1" tabindex="-1"><a class="header-anchor" href="#介绍-1" aria-hidden="true">#</a> 介绍</h5><ul><li><p><strong>hystrix-go</strong> 是熔断、降级、限流集成类库</p></li><li><p>熔断的意义：熔断器是当依赖的服务已经出现故障时，为了保证自身服务的正常运行不在访问依赖的服务，防止雪崩效应</p></li><li><p>降级的意义：当服务器压力剧增时，根据业务策略降级，以此释放服务资源保证业务正常</p></li><li><p>熔断器的三种状态</p><ul><li><p><strong>关闭状态</strong></p><ul><li>服务正常，维护失败率统计，达到失败率阈值时，转到开启状态</li></ul></li><li><p><strong>开启状态</strong></p><ul><li>服务异常，调用fallback函数，一段时间后，进入半开启状态</li></ul></li><li><p><strong>半开启状态</strong></p><ul><li>尝试恢复服务，失败率高于阈值，进入开启状态。低于阈值，进入关闭状态</li></ul></li></ul></li></ul><p><img src="/docs/images/ronduan.png" alt=""></p><h5 id="代码实现-2" tabindex="-1"><a class="header-anchor" href="#代码实现-2" aria-hidden="true">#</a> 代码实现</h5><ul><li><strong><a href="https://github.com/mlabouardy/hystrix-dashboard-docker" target="_blank" rel="noopener noreferrer">hystrix-go dashboard<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></li></ul><details class="custom-container details"><summary>点击查看代码</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;github.com/afex/hystrix-go/hystrix&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_main</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	hystrixStreamHandler <span class="token operator">:=</span> hystrix<span class="token punctuation">.</span><span class="token function">NewStreamHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hystrixStreamHandler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8074&quot;</span><span class="token punctuation">,</span> hystrixStreamHandler<span class="token punctuation">)</span>

	hystrix<span class="token punctuation">.</span><span class="token function">ConfigureCommand</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> hystrix<span class="token punctuation">.</span>CommandConfig<span class="token punctuation">{</span>
		Timeout<span class="token punctuation">:</span>                <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 单次请求 超时时间</span>
		MaxConcurrentRequests<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// 最大并发量</span>
		SleepWindow<span class="token punctuation">:</span>            <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token comment">// 熔断后多久去尝试服务是否可用</span>
		RequestVolumeThreshold<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// 验证熔断的 请求数量, 10秒内采样</span>
		ErrorPercentThreshold<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// 验证熔断的 错误百分比</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//异步调用使用 hystrix.Go</span>
		err <span class="token operator">:=</span> hystrix<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token comment">//test case 1 并发测试</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;service error&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//test case 2 超时测试</span>
			<span class="token comment">//time.Sleep(2 * time.Second)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;do services&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hystrix err:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;sleep 1 second&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div></details><h2 id="websocket代理" tabindex="-1"><a class="header-anchor" href="#websocket代理" aria-hidden="true">#</a> websocket代理</h2><h3 id="http1-x、https、http2-x协议" tabindex="-1"><a class="header-anchor" href="#http1-x、https、http2-x协议" aria-hidden="true">#</a> http1.x、https、http2.x协议</h3><h4 id="_1-http与https的区别" tabindex="-1"><a class="header-anchor" href="#_1-http与https的区别" aria-hidden="true">#</a> 1. http与https的区别</h4><ul><li>https 协议需要 CA 申请证书(换句换说,是要钱的)</li><li>http 协议运行在 TCP 协议之上，传输的内容都是明文传送,安全性较差。而 https 则是运行在 SSL/TLS 层之上，而 SSL/TLS 层是运行在 TCP 层之上 ， https 传输的内容都是经过加密的，安全性较高</li><li>http 与 https 使用不同的连接方式，其中 http 默认用的是 80 端口，而 https 默认用的是 443 端口</li></ul><p><img src="/docs/images/http-https.jpg" alt=""></p><h4 id="_2-http2-0和http1-x的区别" tabindex="-1"><a class="header-anchor" href="#_2-http2-0和http1-x的区别" aria-hidden="true">#</a> 2. http2.0和http1.x的区别:</h4><ul><li><p>http1.x 是基于文本协议的格式解析， 而 http2.0 是基于二进制协议的格式解析，更加的强大</p></li><li><p>多路复用(Mutiplexing) ：一个连接上可以有多个 request， 且可以随机的混在一起,。每个不同的 request 都有对应的 id，服务端可以通过 request_id 来辨别，大大加快了传输速率</p></li><li><p>header 压缩：http1.x 中的 header 需要携带大量信息，而且每次都要重复发送。http2.0 使用 encode 来减少传输的 header 大小，而且客户端和服务端可以各自缓存 (cache) 一份 header filed 表，避免了 header 的重复传输，还可以减少传输的大小。</p></li><li><p>服务端推送 (server push): 可以通过解析 html 中的依赖，本能的返回所需的其他文件( css 或者 js 等)，而不用再发起一次请求。</p></li></ul><h5 id="_2-1-多路复用示意图" tabindex="-1"><a class="header-anchor" href="#_2-1-多路复用示意图" aria-hidden="true">#</a> 2.1 多路复用示意图</h5><p><img src="/docs/images/duolufuyong.jpg" alt=""></p><h5 id="_2-2-普通请求示意图" tabindex="-1"><a class="header-anchor" href="#_2-2-普通请求示意图" aria-hidden="true">#</a> 2.2 普通请求示意图</h5><p><img src="/docs/images/putongrequest.jpg" alt=""></p><h5 id="_2-3-消息推送示意图" tabindex="-1"><a class="header-anchor" href="#_2-3-消息推送示意图" aria-hidden="true">#</a> 2.3 消息推送示意图</h5><p><img src="/docs/images/msgpush.jpg" alt=""></p><h2 id="tcp代理" tabindex="-1"><a class="header-anchor" href="#tcp代理" aria-hidden="true">#</a> tcp代理</h2><h2 id="grpc代理" tabindex="-1"><a class="header-anchor" href="#grpc代理" aria-hidden="true">#</a> grpc代理</h2><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: rulingjia@163.com">jiaruling</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: rulingjia@163.com">âjiaruling</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 56283208+jiaruling@users.noreply.github.com">jiaruling</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/docs/combat/gateway/net.html" class="" aria-label="PreStudy"><!--[--><!--]--> PreStudy <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/docs/assets/app.9a368eb2.js" defer></script>
  </body>
</html>
